<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Games1area | Ultra Arena âš¡</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root { --main: #0f0; --shaieb: #ffcc00; --bg: #080808; --danger: #ff003c; --card-back: #1e3799; }
        
        body { background: #000; color: white; font-family: 'Cairo', sans-serif; margin: 0; text-align: center; overflow: hidden; touch-action: manipulation; }
        
        .bg-panoramic {
            position: fixed; top: 0; left: 0; width: 400%; height: 100%;
            background: url('https://raw.githubusercontent.com/youssefzeweil1-source/Games1area/main/bg.png') repeat-x;
            background-size: contain; z-index: -1;
            animation: moveBg 60s linear infinite alternate;
            filter: brightness(0.3);
        }
        @keyframes moveBg { from { transform: translateX(0); } to { transform: translateX(-50%); } }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© */
        #setup, #lobby, #game-ui { position: relative; z-index: 1; backdrop-filter: blur(5px); min-height: 100vh; }
        
        /* Lobby Styles */
        .player-slot { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; margin: 10px auto; width: 80%; border: 2px solid #333; font-weight: bold; display: flex; flex-direction: column; align-items: flex-start; }
        .slot-top { width: 100%; display: flex; justify-content: space-between; align-items: center; }
        .player-slot.active { border-color: var(--main); background: rgba(0,255,0,0.1); color: var(--main); }
        .status-tag { font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; background: #333; color: #fff; }
        .status-tag.ready { background: var(--main); color: #000; }
        .vote-label { font-size: 0.7rem; color: var(--shaieb); margin-top: 5px; font-weight: normal; }

        .vote-card { background: rgba(34, 34, 34, 0.9); padding: 15px; border-radius: 15px; margin: 5px; display: inline-block; width: 40%; cursor: pointer; border: 2px solid #444; transition: 0.3s; }
        .vote-card.selected { border-color: var(--main); box-shadow: 0 0 15px var(--main); transform: scale(1.05); }

        /* UI Basics */
        .btn-main { background: var(--main); color: #000; border: none; padding: 15px 40px; border-radius: 50px; font-weight: 900; cursor: pointer; box-shadow: 0 0 20px rgba(0,255,0,0.4); }
        .tabs { display: flex; overflow-x: auto; background: rgba(17, 17, 17, 0.8); padding: 5px; gap: 5px; border-bottom: 2px solid #222; }
        .tab { flex: 1; min-width: 80px; padding: 10px; font-size: 0.7rem; font-weight: bold; color: #555; background: rgba(26, 26, 26, 0.8); border-radius: 10px; cursor: pointer; }
        .tab.active { color: #000; background: var(--main); box-shadow: 0 0 15px var(--main); }

        /* Speed War */
        #war-container { width: 90%; height: 400px; margin: 10px auto; border: 4px solid #222; border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; background: rgba(0,0,0,0.5); }
        .war-half { transition: height 0.05s linear; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; text-shadow: 0 0 10px rgba(0,0,0,0.5); }

        /* Bomb */
        #bomb-circle { width: 140px; height: 140px; border-radius: 50%; border: 8px solid var(--danger); margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 900; box-shadow: 0 0 30px var(--danger); background: rgba(0,0,0,0.6); }
        .num-btn { background: #222; border: 1px solid #444; color: white; padding: 12px 20px; border-radius: 10px; font-size: 1.5rem; margin: 5px; }

        /* Cards (Shaieb) */
        .card { width: 50px; height: 75px; background: white; color: black; border-radius: 8px; display: inline-flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; margin: 3px; font-size: 0.9rem; border: 1px solid #ccc; }
        .card.back { background: var(--card-back); color: transparent; border: 2px solid #fff; }
        .card.red { color: #ff003c; }
        .card.shaieb { background: var(--danger); color: white; box-shadow: 0 0 10px red; }

        /* XO */
        .xo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 280px; margin: auto; }
        .cell { height: 80px; background: rgba(21, 21, 21, 0.8); border-radius: 15px; font-size: 2.5rem; display: flex; align-items: center; justify-content: center; border: 2px solid #222; }

        .hidden { display: none !important; }
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: black; padding: 25px 40px; border-radius: 25px; font-weight: 900; font-size: 1.4rem; z-index: 10000; text-align: center; border: 5px solid var(--main); line-height: 1.4; box-shadow: 0 0 100px rgba(0,0,0,0.8); }
    </style>
</head>
<body>

<div class="bg-panoramic"></div>

<div id="setup" style="padding-top: 100px;">
    <h1 style="color:var(--main); font-size: 3.5rem; margin:0; letter-spacing: -2px; text-shadow: 0 0 20px var(--main);">ARENA âš¡</h1>
    <p style="color:#bbb;">Ø£Ø³Ø±Ø¹ ÙˆØ§Ø­Ø¯ Ø¨ÙŠÙƒØ³Ø¨ØŒ ÙˆØ§Ù„Ø£Ø®ÙŠØ¨ Ø¨Ø¨ÙŠØªÙ…Ø³Ø®Ø±!</p>
    <input type="text" id="room" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©" style="padding:15px; border-radius:15px; border:1px solid #333; background:rgba(0,0,0,0.7); color:white; width:200px; text-align:center;"><br><br>
    <button class="btn-main" onclick="joinRoom()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø­Ø©</button>
</div>

<div id="lobby" class="hidden" style="padding-top: 50px;">
    <h2 style="color:var(--main)">ØºØ±ÙØ© Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ âš”ï¸</h2>
    
    <div id="p1-slot" class="player-slot">
        <div class="slot-top">
            <span>Ù„Ø§Ø¹Ø¨ 1</span>
            <span id="p1-ready" class="status-tag">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
        </div>
        <div id="p1-vote-display" class="vote-label"></div>
    </div>
    <div id="p2-slot" class="player-slot">
        <div class="slot-top">
            <span>Ù„Ø§Ø¹Ø¨ 2</span>
            <span id="p2-ready" class="status-tag">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
        </div>
        <div id="p2-vote-display" class="vote-label"></div>
    </div>

    <button id="ready-btn" class="btn-main" onclick="iamReady()" style="margin-top: 20px;">Ø£Ù†Ø§ Ù…Ø³ØªØ¹Ø¯! ğŸ”¥</button>
    
    <div id="voting-area" class="hidden" style="margin-top: 30px; border-top: 2px solid #222; padding-top: 20px;">
        <h3 style="color:var(--shaieb)">ØµÙˆÙ‘ØªÙˆØ§ Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ù„Ø­Ù…Ø©:</h3>
        <div class="vote-card" id="v-war" onclick="vote('war')">Ø§Ù„Ø³Ø±Ø¹Ø© âš¡</div>
        <div class="vote-card" id="v-sh" onclick="vote('sh')">Ø§Ù„Ø´Ø§ÙŠØ¨ ğŸ¤¡</div>
        <div class="vote-card" id="v-bomb" onclick="vote('bomb')">Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© ğŸ’£</div>
        <div class="vote-card" id="v-xo" onclick="vote('xo')">XO â­•</div>
    </div>
</div>

<div id="game-ui" class="hidden">
    <div class="tabs">
        <div id="t-war" class="tab active" onclick="switchUI('war')">Ø§Ù„Ø³Ø±Ø¹Ø© âš¡</div>
        <div id="t-sh" class="tab" onclick="switchUI('sh')">Ø§Ù„Ø´Ø§ÙŠØ¨ ğŸ¤¡</div>
        <div id="t-bomb" class="tab" onclick="switchUI('bomb')">Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© ğŸ’£</div>
        <div id="t-xo" class="tab" onclick="switchUI('xo')">XO â­•</div>
    </div>

    <div id="war-ui">
        <div id="war-container" onclick="tapWar(event)">
            <div id="op-war" class="war-half" style="background:var(--danger); height:50%;">Ø§Ù„Ø¶Ø­ÙŠØ©</div>
            <div id="my-war" class="war-half" style="background:var(--main); height:50%;">Ø§Ù„ÙˆØ­Ø´</div>
        </div>
    </div>

    <div id="sh-ui" class="hidden">
        <h3 id="sh-stat" style="color:var(--shaieb); background: rgba(0,0,0,0.5); display: inline-block; padding: 5px 15px; border-radius: 10px;">...</h3>
        <div id="op-area"></div>
        <div id="my-area" style="margin-top:20px;"></div>
    </div>

    <div id="bomb-ui" class="hidden">
        <h2 id="bomb-msg">Ø¯ÙˆØ± Ù…ÙŠÙ†ØŸ</h2>
        <div id="bomb-circle">0</div>
        <div id="bomb-btns">
            <button class="num-btn" onclick="addBomb(1)">+1</button>
            <button class="num-btn" onclick="addBomb(2)">+2</button>
            <button class="num-btn" onclick="addBomb(3)">+3</button>
        </div>
    </div>

    <div id="xo-ui" class="hidden">
        <h3 id="xo-stat" style="color:var(--main); background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 10px;">...</h3>
        <div class="xo-grid" id="xo-board"></div>
    </div>

    <button onclick="clearRoom()" style="background:none; border:none; color:#777; margin-top:30px; text-decoration:underline; font-weight:bold;">Ø³ÙˆÙØª ÙˆÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„ØºØ±ÙØ© ğŸ”„</button>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let rID, mID, rRef, myRole = "", canAction = true;
    const syms = { 'H': 'â™¡', 'D': 'â—‡', 'S': 'â™¤', 'C': 'â™§' };
    const gameNames = { 'war': 'Ø§Ù„Ø³Ø±Ø¹Ø© âš¡', 'sh': 'Ø§Ù„Ø´Ø§ÙŠØ¨ ğŸ¤¡', 'bomb': 'Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© ğŸ’£', 'xo': 'XO â­•' };

    const insults = ["ÙŠØ§ Ù†ÙˆØ¨ Ø§Ø¹ØªØ²Ù„ Ø£Ø­Ø³Ù†! ğŸ˜‚", "Ø³Ø±Ø¹Ø© Ø³Ù„Ø­ÙØ§Ø© Ù…Ø´Ù„ÙˆÙ„Ø© ğŸ¢", "Ø§Ù„Ø¹Ø¨ Ø¨ØµØ¨Ø§Ø¹Ùƒ Ø§Ù„ØªØ§Ù†ÙŠ ÙŠÙ…ÙƒÙ† ØªÙÙ„Ø­ ğŸ¤¡", "Ø´ÙƒÙ„Ùƒ ÙˆØ­Ø´ Ø£ÙˆÙŠ Ù‚Ø¯Ø§Ù… Ø§Ù„Ø®ØµÙ… ğŸ’€", "Ø£Ù†Ø§ Ù„Ùˆ Ù…Ù†Ùƒ Ø£Ø±Ù…ÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ğŸš®", "Ø¬Øª ÙÙŠÙƒ ÙŠØ§ Ø®Ø§ÙŠØ¨! ğŸ’£", "Ø§Ù„Ø®ØµÙ… Ø¯Ø§Ø³ Ø¹Ù„ÙŠÙƒ Ø­Ø±ÙÙŠØ§Ù‹ ğŸ¦¶", "Ø¥ÙŠÙ‡ Ø§Ù„Ø¶Ø­Ùƒ Ø¯Ù‡? ğŸ˜‚"];
    const wins = ["Ø¬Ù„Ø¯ØªÙ‡ Ø¬Ù„Ø¯! ğŸ”¥", "Ù…Ø³ØªÙˆØ§Ùƒ Ø¹Ø§Ù„Ù…ÙŠ ÙŠØ§ ÙˆØ­Ø´ ğŸ¦", "Ø§Ù„Ø®ØµÙ… Ø¨ÙŠØ¹ÙŠØ· ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© ğŸ˜­", "Ø¥ÙŠÙ‡ Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø¯ÙŠ ÙŠØ§ Ù…Ù„Ùƒ! ğŸ‘‘", "Ø³Ù‡Ù„Ø© Ø£ÙˆÙŠ.. Ù‡Ø§Øª Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡ ğŸ˜"];

    function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    function joinRoom() {
        rID = document.getElementById('room').value.trim();
        if(!rID) return alert("Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©!");
        mID = "U" + Math.floor(Math.random()*9999);
        rRef = db.ref(`final_arena_v4/${rID}`);

        rRef.child('slots').transaction(s => {
            if(!s) return { p1: mID };
            if(!s.p2 && s.p1 !== mID) return { p1: s.p1, p2: mID };
            return s;
        }, (err, comm, snap) => {
            const s = snap.val();
            myRole = (s.p1 === mID) ? "p1" : (s.p2 === mID ? "p2" : "viewer");
            rRef.child(`slots/${myRole}`).onDisconnect().remove();
            rRef.child(`ready/${myRole}`).onDisconnect().remove();
            rRef.child(`votes/${myRole}`).onDisconnect().remove();
            
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('lobby').classList.remove('hidden');
            listenLobby();
        });
    }

    function iamReady() {
        if(myRole === 'viewer') return;
        rRef.child(`ready/${myRole}`).set(true);
        document.getElementById('ready-btn').classList.add('hidden');
    }

    function listenLobby() {
        rRef.on('value', snap => {
            const d = snap.val() || {};
            const slots = d.slots || {};
            const ready = d.ready || {};
            const votes = d.votes || {};
            
            // ØªØ­Ø¯ÙŠØ« Ù„Ø§Ø¹Ø¨ 1
            document.getElementById('p1-slot').className = slots.p1 ? "player-slot active" : "player-slot";
            document.getElementById('p1-ready').innerText = ready.p1 ? "Ù…Ø³ØªØ¹Ø¯ âœ…" : (slots.p1 ? "Ø¨ÙŠØ¬Ù‡Ø² Ù†ÙØ³Ù‡.." : "ØºØ§Ø¦Ø¨");
            document.getElementById('p1-ready').className = ready.p1 ? "status-tag ready" : "status-tag";
            document.getElementById('p1-vote-display').innerText = votes.p1 ? "ØµÙˆÙ‘Øª Ù„Ù€: " + gameNames[votes.p1] : "";

            // ØªØ­Ø¯ÙŠØ« Ù„Ø§Ø¹Ø¨ 2
            document.getElementById('p2-slot').className = slots.p2 ? "player-slot active" : "player-slot";
            document.getElementById('p2-ready').innerText = ready.p2 ? "Ù…Ø³ØªØ¹Ø¯ âœ…" : (slots.p2 ? "Ø¨ÙŠØ¬Ù‡Ø² Ù†ÙØ³Ù‡.." : "ØºØ§Ø¦Ø¨");
            document.getElementById('p2-ready').className = ready.p2 ? "status-tag ready" : "status-tag";
            document.getElementById('p2-vote-display').innerText = votes.p2 ? "ØµÙˆÙ‘Øª Ù„Ù€: " + gameNames[votes.p2] : "";

            if (ready.p1 && ready.p2) {
                document.getElementById('voting-area').classList.remove('hidden');
            }

            const v1 = votes.p1;
            const v2 = votes.p2;
            if (v1 && v2 && v1 === v2) {
                rRef.child('activeTab').set(v1);
                rRef.child('gameState').set('playing');
            }

            if (d.gameState === 'playing') {
                document.getElementById('lobby').classList.add('hidden');
                document.getElementById('game-ui').classList.remove('hidden');
                initXO();
                startListeners();
            }
        });
    }

    function vote(game) {
        if (myRole === 'viewer') return;
        rRef.child('votes').update({ [myRole]: game });
        document.querySelectorAll('.vote-card').forEach(el => el.classList.remove('selected'));
        document.getElementById('v-' + game).classList.add('selected');
    }

    function switchUI(t) { rRef.update({ activeTab: t }); }

    function startListeners() {
        rRef.child('activeTab').on('value', s => {
            const t = s.val() || 'war';
            ['war','sh','bomb','xo'].forEach(id => {
                document.getElementById(id+'-ui').classList.add('hidden');
                document.getElementById('t-'+id).classList.remove('active');
            });
            document.getElementById(t+'-ui').classList.remove('hidden');
            document.getElementById('t-'+t).classList.add('active');
        });

        rRef.child('war').on('value', s => {
            const d = s.val() || {p1:50, p2:50};
            const myH = (myRole==='p1'?d.p1:d.p2);
            document.getElementById('my-war').style.height = myH + "%";
            document.getElementById('op-war').style.height = (100-myH) + "%";
            if(myH >= 100) { showBigMsg(getRandom(wins)); if(myRole==='p1') rRef.child('war').set({p1:50, p2:50}); }
            else if (myH <= 0) { showBigMsg(getRandom(insults)); }
        });

        rRef.child('bomb').on('value', s => {
            const d = s.val() || {val:0, turn:'p1'};
            document.getElementById('bomb-circle').innerText = d.val;
            document.getElementById('bomb-msg').innerText = d.turn===myRole ? "Ø¯ÙˆØ±Ùƒ.. Ù„Ø§ ØªÙØ¬Ø±Ù‡Ø§! ğŸ’£" : "Ø§Ø³ØªÙ†Ù‰ Ù„Ù…Ø§ ÙŠÙ†ÙØ¬Ø± ğŸ˜‚";
            if(d.status === 'exploded') {
                showBigMsg(d.turn===myRole ? getRandom(insults) : getRandom(wins));
                if(myRole==='p1') setTimeout(()=> rRef.child('bomb').remove(), 3000);
            }
        });

        rRef.child('sh').on('value', s => {
            const d = s.val();
            if(!d && myRole==='p1') setupSh(); else if(d) renderSh(d);
        });

        rRef.child('xo').on('value', s => {
            const d = s.val() || { b: Array(9).fill(""), turn: "p1" };
            const cells = document.querySelectorAll('.cell');
            d.b.forEach((v, i) => { cells[i].innerText = v; cells[i].style.color = (v==='X'?'#0f0':'#f00'); });
            if(d.win) {
                showBigMsg(d.winRole===myRole ? getRandom(wins) : getRandom(insults));
                if(myRole==='p1') setTimeout(()=> rRef.child('xo').remove(), 3000);
            }
        });
    }

    function tapWar(e) {
        if(myRole==='viewer') return;
        rRef.child('war').transaction(d => {
            if(!d) d = {p1:50, p2:50};
            if(myRole==='p1') { d.p1+=2; d.p2-=2; } else { d.p2+=2; d.p1-=2; }
            return d;
        });
    }

    function addBomb(n) {
        rRef.child('bomb').once('value', s => {
            const d = s.val() || {val:0, limit: Math.floor(Math.random()*20)+40, turn:'p1'};
            if(d.turn !== myRole || d.status === 'exploded') return;
            let nv = d.val + n;
            let exp = nv >= d.limit;
            rRef.child('bomb').update({ val:nv, turn:(myRole==='p1'?'p2':'p1'), status:exp?'exploded':'playing', limit:d.limit });
        });
    }

    function setupSh() {
        const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        let deck = [];
        ['H','S','D','C'].forEach(s => ranks.forEach(r => deck.push({r, s})));
        deck.splice(Math.floor(Math.random()*52), 1);
        deck.push({r:'SHAIEB', s:'ğŸ¤¡'});
        deck = deck.sort(()=>Math.random()-0.5);
        const filter = (a) => {
            let ct = {}; a.forEach(c => ct[c.r] = (ct[c.r]||0)+1);
            return a.filter(c => c.r==='SHAIEB' || ct[c.r]%2!==0);
        };
        rRef.child('sh').set({ p1C: filter(deck.slice(0,26)), p2C: filter(deck.slice(26)), turn:'p1' });
    }

    function renderSh(d) {
        const myC = (myRole==='p1'?d.p1C:d.p2C) || [], opC = (myRole==='p1'?d.p2C:d.p1C) || [];
        const isT = (d.turn === myRole);
        document.getElementById('sh-stat').innerText = isT ? "Ø§Ø³Ø­Ø¨ ÙˆØ±Ù‚Ø© Ù…Ù† Ø§Ù„Ø¶Ø­ÙŠØ©" : "Ø¨ÙŠØ³Ø­Ø¨ Ù…Ù†Ùƒ.. ÙŠØ§ Ø±Ø¨ Ù…ÙŠØ§Ø®Ø¯Ø´ Ø§Ù„Ø´Ø§ÙŠØ¨";
        const opB = document.getElementById('op-area'); opB.innerHTML = "";
        opC.forEach((_,i) => { 
            let v = document.createElement('div'); v.className="card back"; 
            v.onclick=()=>pullSh(i); opB.appendChild(v); 
        });
        const myB = document.getElementById('my-area'); myB.innerHTML = "";
        myC.forEach(c => {
            let v = document.createElement('div'); v.className=`card ${'HD'.includes(c.s)?'red':''} ${c.r==='SHAIEB'?'shaieb':''}`;
            v.innerHTML = `<span>${c.r==='SHAIEB'?'ğŸ¤¡':c.r+syms[c.s]}</span>`;
            myB.appendChild(v);
        });
        if(myC.length===0 && opC.length>0 && d.status !== 'done') {
            showBigMsg("Ù‡Ø±Ø¨Øª Ø¨Ø§Ù„Ø³Ù„Ø§Ù…Ø©! " + getRandom(wins));
            rRef.child('sh/status').set('done');
        }
    }

    function pullSh(idx) {
        if(!canAction) return; canAction = false;
        rRef.child('sh').once('value', s => {
            let d = s.val(); if(!d || d.turn !== myRole) { canAction=true; return; }
            let mk = (myRole==='p1'?'p1C':'p2C'), ok = (myRole==='p1'?'p2C':'p1C');
            let ma = [...(d[mk]||[])], oa = [...(d[ok]||[])];
            let pld = oa.splice(idx,1)[0];
            let pi = ma.findIndex(c => c.r === pld.r && c.r !== 'SHAIEB');
            if(pi!==-1) ma.splice(pi,1); else ma.push(pld);
            rRef.child('sh').update({ [mk]:ma, [ok]:oa, turn:(myRole==='p1'?'p2':'p1') }).then(()=>setTimeout(()=>canAction=true,800));
        });
    }

    function initXO() {
        const b = document.getElementById('xo-board'); b.innerHTML = "";
        for(let i=0; i<9; i++) { let v = document.createElement('div'); v.className="cell"; v.onclick=()=>tapXO(i); b.appendChild(v); }
    }
    function tapXO(i) {
        rRef.child('xo').once('value', s => {
            let d = s.val() || { b: Array(9).fill(""), turn: "p1" };
            if(myRole !== d.turn || d.b[i] || d.win) return;
            d.b[i] = (myRole === 'p1') ? 'X' : 'O';
            const wns = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            wns.forEach(w => { if(d.b[w[0]] && d.b[w[0]]===d.b[w[1]] && d.b[w[0]]===d.b[w[2]]) { d.win=d.b[w[0]]; d.winRole=myRole; } });
            if(!d.win) d.turn = (myRole==='p1'?'p2':'p1');
            rRef.child('xo').update(d);
        });
    }

    function showBigMsg(txt) {
        const t = document.createElement('div'); t.className='toast'; t.innerText=txt;
        document.body.appendChild(t); setTimeout(()=>t.remove(), 2500);
    }

    function clearRoom() {
        if(confirm("ØªØµÙÙŠØ± Ø´Ø§Ù…Ù„ØŸ Ø§Ù„ØºØ±ÙØ© Ù‡ØªØ±Ø¬Ø¹ ÙƒØ£Ù†Ù‡Ø§ Ø¬Ø¯ÙŠØ¯Ø©!")) {
            rRef.remove();
            location.reload();
        }
    }
</script>
</body>
</html>
