<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Games1area | Pro Challenge ğŸ®</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --main: #0f0; --shaieb: #ffcc00; --bg: #0d0d0d; --danger: #ff4d4d; --card-back: #1e3799; }
        body { background: var(--bg); color: white; font-family: 'Cairo', sans-serif; margin: 0; text-align: center; user-select: none; overflow-x: hidden; }
        
        #setup { padding: 80px 20px; }
        .input-style { padding: 15px; border-radius: 12px; border: 1px solid #333; width: 250px; background: #1a1a1a; color: #fff; text-align: center; font-size: 1.1rem; outline: none; }
        .btn-main { background: var(--main); color: #000; border: none; padding: 15px 40px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1.1rem; box-shadow: 0 5px 15px rgba(0,255,0,0.3); transition: 0.3s; }
        .btn-main:hover { transform: scale(1.05); }

        .tabs { display: flex; max-width: 400px; margin: 20px auto; background: #1a1a1a; border-radius: 50px; padding: 5px; border: 1px solid #333; }
        .tab { flex: 1; padding: 12px; cursor: pointer; font-weight: bold; color: #777; border-radius: 50px; transition: 0.3s; }
        .tab.active { color: #000; background: var(--main); }

        /* Ø§Ù„Ø´Ø§ÙŠØ¨ UI */
        #sh-ui { padding: 10px; }
        .card { width: 60px; height: 90px; background: white; color: black; border-radius: 10px; display: inline-flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; margin: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; border: 1px solid #ddd; position: relative; transition: 0.2s; vertical-align: top; }
        .card:hover { transform: translateY(-8px); }
        .card.red { color: #d63031; }
        .card.back { background: linear-gradient(135deg, var(--card-back), #0c2461); border: 2px solid #fff; color: transparent; }
        .card.shaieb { background: var(--danger); color: white; animation: shake 0.5s infinite; border: 2px solid #fff; }
        .card.disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); transform: none !important; }

        @keyframes shake { 0%,100% {transform:rotate(0)} 25% {transform:rotate(4deg)} 75% {transform:rotate(-4deg)} }
        
        /* XO UI */
        .xo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 300px; margin: auto; }
        .cell { height: 90px; background: #151515; border-radius: 15px; font-size: 2.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #222; transition: 0.3s; }
        .cell:not(:empty) { animation: pop 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        .win-cell { background: var(--main) !important; color: #000 !important; box-shadow: 0 0 20px var(--main); }

        .toast { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); padding: 20px; border-radius: 15px; font-weight: bold; z-index: 10000; background: var(--shaieb); color: #000; border: 3px solid #000; font-size: 1.2rem; animation: bounceIn 0.5s forwards; pointer-events: none; width: 80%; max-width: 250px; }
        @keyframes bounceIn { 0% { transform: translate(-50%, -80%) scale(0.5); opacity: 0; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="setup">
    <h1 style="color:var(--main); font-size: 2.5rem; margin-bottom: 5px;">Games1area ğŸ®</h1>
    <p style="color: #888;">ØªØ­Ø¯ÙŠ Ø§Ù„ØµÙ…ÙˆØ¯.. Ø§Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù† Ø§Ù„Ø´Ø§ÙŠØ¨!</p>
    <input type="text" id="room" class="input-style" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (Ù…Ø«Ù„Ø§Ù‹: 777)"><br><br>
    <button class="btn-main" onclick="joinRoom()">Ø¯Ø®ÙˆÙ„ Ø§Ù„ØºØ±ÙØ©</button>
</div>

<div id="game-ui" class="hidden">
    <div class="tabs">
        <div id="t-xo" class="tab active" onclick="switchUI('xo')">X-O</div>
        <div id="t-sh" class="tab" onclick="switchUI('sh')">Ø§Ù„Ø´Ø§ÙŠØ¨ ğŸ¤¡</div>
    </div>

    <div id="xo-ui">
        <h3 id="xo-stat" style="color:var(--main)">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø®ØµÙ…..</h3>
        <div class="xo-grid" id="xo-board"></div>
    </div>

    <div id="sh-ui" class="hidden">
        <h3 id="sh-stat" style="color:var(--shaieb)">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹..</h3>
        <div id="op-area" style="min-height:110px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin: 10px;"></div>
        <div style="margin: 10px 0; font-size: 0.8rem; color: #666;">ÙˆØ±Ù‚Ùƒ Ø£Ù†Øª (Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„ØºØ´ ğŸ¤«)</div>
        <div id="my-area" style="min-height:110px; padding: 10px;"></div>
    </div>

    <button onclick="clearRoom()" style="margin-top:40px; color:var(--danger); background:none; border:none; cursor:pointer; text-decoration: underline; font-family: 'Cairo';">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØºØ±ÙØ© ğŸ”„</button>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let rID, mID, rRef, myRole = ""; 
    let canAction = true;
    const syms = { 'H': 'â™¡', 'D': 'â—‡', 'S': 'â™¤', 'C': 'â™§' };
    const insults = ["ÙŠØ§ ÙˆØ§Ø¯ ÙŠØ§ Ù…Ø­Ø¸ÙˆØ¸! ğŸ€", "Ø§Ù„Ø´Ø§ÙŠØ¨ Ø¨ÙŠØ³Ù„Ù… Ø¹Ù„ÙŠÙƒ.. ğŸ¤¡", "Ø´ÙƒÙ„Ùƒ Ù‡ØªØ¨Ø§Øª Ù…Ø¹ Ø§Ù„Ø´Ø§ÙŠØ¨! â›º", "Ø³Ø­Ø¨ØªÙ‡Ø§ Ø¨Ø«Ù‚Ø© ÙˆØ·Ù„Ø¹Øª Ø®Ø§Ø²ÙˆÙ‚! ğŸ’€", "Ø³Ø±Ù‚ØªÙƒ ÙŠØ§ Ù…ØºÙÙ„! ğŸ˜ˆ"];

    function showMsg(txt) {
        const old = document.querySelector('.toast'); if(old) old.remove();
        const t = document.createElement('div'); t.className = 'toast';
        t.innerText = txt; document.body.appendChild(t);
        setTimeout(() => { if(t) t.remove(); }, 2000);
    }

    function joinRoom() {
        rID = document.getElementById('room').value.trim();
        if(!rID) return alert("Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©!");
        mID = "U" + Math.floor(Math.random()*9999);
        rRef = db.ref(`pro_version_v15/${rID}`);

        rRef.child('slots').transaction(s => {
            if(!s) return { p1: mID };
            if(!s.p2 && s.p1 !== mID) return { p1: s.p1, p2: mID };
            return s;
        }, (err, committed, snap) => {
            const s = snap.val();
            myRole = (s.p1 === mID) ? "p1" : (s.p2 === mID ? "p2" : "viewer");
            
            // Ù„ÙˆØ¬ÙŠÙƒ Ø§Ù„Ù‡Ø±ÙˆØ¨ (Disconnect)
            rRef.child(`slots/${myRole}`).onDisconnect().remove();
            
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            initXO();
            startListeners();
        });
    }

    function initXO() {
        const board = document.getElementById('xo-board'); board.innerHTML = "";
        for(let i=0; i<9; i++) {
            let div = document.createElement('div'); div.className = "cell";
            div.onclick = () => tapXO(i); board.appendChild(div);
        }
    }

    function startListeners() {
        rRef.child('activeTab').on('value', s => {
            const t = s.val() || 'xo';
            document.getElementById('xo-ui').classList.toggle('hidden', t !== 'xo');
            document.getElementById('sh-ui').classList.toggle('hidden', t !== 'sh');
            document.getElementById('t-xo').classList.toggle('active', t === 'xo');
            document.getElementById('t-sh').classList.toggle('active', t === 'sh');
        });

        rRef.child('xo').on('value', s => {
            const d = s.val() || { b: Array(9).fill(""), turn: "p1", win: false, winCells: [] };
            const cells = document.querySelectorAll('.cell');
            d.b.forEach((v, i) => { 
                cells[i].innerText = v; 
                cells[i].style.color = (v==='X'?'#0f0':'#f00');
                cells[i].classList.toggle('win-cell', d.winCells && d.winCells.includes(i));
            });
            document.getElementById('xo-stat').innerText = d.win ? `Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ ${d.win} ğŸ†` : (myRole === d.turn ? "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù† âœ…" : "Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø®ØµÙ…..");
        });

        rRef.child('sh').on('value', s => {
            const d = s.val();
            if(!d && myRole === 'p1') setupSh();
            else if(d) {
                renderSh(d);
                if(d.lastMsg && d.msgID !== window.lastMsgID) {
                    showMsg(d.lastMsg); window.lastMsgID = d.msgID;
                }
            }
        });
    }

    function switchUI(t) { rRef.update({ activeTab: t }); }

    function tapXO(i) {
        rRef.child('xo').once('value', s => {
            let d = s.val() || { b: Array(9).fill(""), turn: "p1", win: false };
            if(myRole !== d.turn || d.b[i] || d.win) return;
            d.b[i] = (myRole === 'p1') ? 'X' : 'O';
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for(let w of wins) {
                if(d.b[w[0]] && d.b[w[0]]===d.b[w[1]] && d.b[w[0]]===d.b[w[2]]) {
                    d.win = d.b[w[0]]; d.winCells = w;
                }
            }
            if(!d.win) d.turn = (myRole === 'p1') ? 'p2' : 'p1';
            rRef.child('xo').update(d);
        });
    }

    function setupSh() {
        const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        let deck = [];
        ['H','S','D','C'].forEach(s => ranks.forEach(r => deck.push({r, s})));
        deck.splice(Math.floor(Math.random()*52), 1); // Ø­Ø°Ù ÙˆØ±Ù‚Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„Ø¬Ø¹Ù„ ÙˆØ§Ø­Ø¯Ø© ÙŠØªÙŠÙ…Ø©
        deck.push({r:'SHAIEB', s:'ğŸ¤¡'});
        deck = deck.sort(() => Math.random() - 0.5);

        const filterPairs = (arr) => {
            let counts = {};
            arr.forEach(c => counts[c.r] = (counts[c.r] || 0) + 1);
            return arr.filter(c => c.r === 'SHAIEB' || counts[c.r] % 2 !== 0);
        };

        let p1C = filterPairs(deck.slice(0, 26));
        let p2C = filterPairs(deck.slice(26));
        rRef.child('sh').set({ p1C, p2C, turn: 'p1', lastMsg: "ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙˆØ±Ù‚ ÙˆØªØµÙÙŠØ© Ø§Ù„Ø£Ø²ÙˆØ§Ø¬! ğŸ”¥" });
    }

    function renderSh(d) {
        const myC = (myRole === 'p1' ? d.p1C : d.p2C) || [];
        const opC = (myRole === 'p1' ? d.p2C : d.p1C) || [];
        const isTurn = (d.turn === myRole);
        document.getElementById('sh-stat').innerText = isTurn ? "Ø§Ø³Ø­Ø¨ ÙˆØ±Ù‚Ø© Ù…Ù† Ø®ØµÙ…Ùƒ! ğŸ‘€" : "Ø®ØµÙ…Ùƒ ÙŠØ³Ø­Ø¨ Ø§Ù„Ø¢Ù†.. ğŸ¤";

        const opB = document.getElementById('op-area'); opB.innerHTML = "";
        opC.forEach((_, i) => {
            let div = document.createElement('div');
            div.className = "card back" + (isTurn ? "" : " disabled");
            div.onclick = () => pullSh(i); opB.appendChild(div);
        });

        const myB = document.getElementById('my-area'); myB.innerHTML = "";
        myC.forEach(c => {
            let div = document.createElement('div');
            div.className = `card ${'HD'.includes(c.s)?'red':''} ${c.r==='SHAIEB'?'shaieb':''}`;
            div.innerHTML = `<span>${c.r==='SHAIEB'?'':c.r}</span><span style="font-size:20px">${c.r==='SHAIEB'?'ğŸ¤¡':syms[c.s]}</span>`;
            myB.appendChild(div);
        });

        if (myC.length === 0 && opC.length > 0) { showMsg("ğŸ‰ ÙØ²Øª ÙˆÙ‡Ø±Øª!"); rRef.child('sh/lastMsg').set("Ø§Ù„Ø®ØµÙ… ÙØ§Ø² ÙˆÙ‡Ø±Ø¨! ğŸƒâ€â™‚ï¸"); }
    }

    function pullSh(idx) {
        if(!canAction) return;
        rRef.child('sh').once('value', s => {
            let d = s.val();
            if(!d || d.turn !== myRole) return;
            canAction = false;
            let myKey = (myRole === 'p1' ? 'p1C' : 'p2C');
            let opKey = (myRole === 'p1' ? 'p2C' : 'p1C');
            let myArr = [...(d[myKey] || [])];
            let opArr = [...(d[opKey] || [])];
            if(opArr.length === 0) return canAction = true;

            let card = opArr.splice(idx, 1)[0];
            myArr.push(card);
            
            let counts = {};
            myArr.forEach(c => counts[c.r] = (counts[c.r] || 0) + 1);
            let hasPair = myArr.some(c => c.r !== 'SHAIEB' && counts[c.r] >= 2);
            let cleaned = myArr.filter(c => c.r === 'SHAIEB' || counts[c.r] % 2 !== 0);

            const msg = insults[Math.floor(Math.random() * insults.length)];
            let up = { [myKey]: cleaned, [opKey]: opArr, turn: (myRole === 'p1' ? 'p2' : 'p1'), lastMsg: hasPair ? "âœ¨ Ø·Ø§Ø± Ø²ÙˆØ¬! Ùˆ " + msg : msg, msgID: Math.random() };
            rRef.child('sh').update(up).then(() => setTimeout(() => canAction = true, 600));
        });
    }

    function clearRoom() {
        if(confirm("Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØºØ±ÙØ©ØŸ")) { rRef.remove(); location.reload(); }
    }
</script>
</body>
</html>
