<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Games1area | Ultra Arena âš¡</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root { --main: #0f0; --shaieb: #ffcc00; --bg: #080808; --danger: #ff003c; --card-back: #1e3799; --gold: #ffd700; }
        
        body { background: #000; color: white; font-family: 'Cairo', sans-serif; margin: 0; text-align: center; overflow: hidden; touch-action: manipulation; }
        
        #player-stats-bar {
            position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); padding: 5px 20px; border-radius: 50px;
            border: 1px solid var(--gold); z-index: 100000; display: flex; gap: 20px;
            font-weight: 900; box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        /* Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø§Ù†ÙˆØ±Ø§Ù…ÙŠØ© */
        .bg-panoramic {
            position: fixed; top: 0; left: 0; width: 400%; height: 100%;
            background: url('https://raw.githubusercontent.com/youssefweil1-source/Games1area/main/bg.png') repeat-x;
            background-size: contain; z-index: -1;
            animation: moveBg 60s linear infinite alternate;
            filter: brightness(0.3);
            will-change: transform;
        }
        @keyframes moveBg { from { transform: translateX(0); } to { transform: translateX(-50%); } }

        #music-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: rgba(10, 10, 10, 0.98); border: 3px solid var(--main);
            padding: 25px; border-radius: 30px; z-index: 100001; width: 280px;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.3);
        }
        #music-modal.open { transform: translate(-50%, -50%) scale(1); }
        .music-option {
            background: #1a1a1a; border: 2px solid #333; color: white;
            padding: 15px; margin: 12px 0; border-radius: 15px; cursor: pointer;
            font-weight: 900; transition: 0.2s;
        }
        .music-option:active { transform: scale(0.95); background: var(--main); color: black; }
        
        #music-btn {
            position: fixed; top: 15px; right: 15px; background: var(--main);
            color: black; border-radius: 10px; padding: 10px 15px;
            font-weight: bold; cursor: pointer; z-index: 100000; 
            box-shadow: 0 0 15px var(--main);
        }

        #store-btn {
            position: fixed; top: 15px; left: 15px; background: var(--gold);
            color: black; border-radius: 10px; padding: 10px 15px;
            font-weight: bold; cursor: pointer; z-index: 100000;
            box-shadow: 0 0 15px var(--gold); border: none;
        }

        #skills-overlay {
            position: fixed; bottom: 100px; right: 20px;
            display: flex; flex-direction: column; gap: 10px; z-index: 1000;
        }
        .skill-use-btn {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid white;
            font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: relative;
        }
        .skill-count {
            position: absolute; top: -5px; right: -5px; background: red;
            color: white; font-size: 0.7rem; padding: 2px 5px; border-radius: 50%;
        }

        #setup, #lobby, #voting-screen { position: relative; z-index: 1; backdrop-filter: blur(5px); min-height: 100vh; }
        
        #game-ui { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
        }

        .player-slot { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; margin: 10px auto; width: 80%; border: 2px solid #333; font-weight: bold; display: flex; flex-direction: column; align-items: flex-start; }
        .slot-top { width: 100%; display: flex; justify-content: space-between; align-items: center; }
        .player-slot.active { border-color: var(--main); background: rgba(0,255,0,0.1); color: var(--main); }
        .status-tag { font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; background: #333; color: #fff; }
        .status-tag.ready { background: var(--main); color: #000; }

        .vote-card { background: rgba(34, 34, 34, 0.9); padding: 10px; border-radius: 20px; margin: 8px; display: inline-block; width: 42%; cursor: pointer; border: 2px solid #444; transition: 0.3s; overflow: hidden; }
        .vote-card.selected { border-color: var(--main); box-shadow: 0 0 20px var(--main); transform: scale(1.05); }
        .vote-img { width: 100%; height: 80px; object-fit: cover; border-radius: 12px; margin-bottom: 8px; display: block; background: #222; }
        .vote-name { font-weight: 900; font-size: 0.9rem; }

        .status-bar { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; margin: 10px auto; width: 85%; border-left: 4px solid var(--main); display: flex; justify-content: space-around; font-size: 0.85rem; }

        .btn-main { background: var(--main); color: #000; border: none; padding: 15px 40px; border-radius: 50px; font-weight: 900; cursor: pointer; box-shadow: 0 0 20px rgba(0,255,0,0.4); }

        #war-container { width: 100vw; height: 100vh; margin: 0; border: none; border-radius: 0; overflow: hidden; display: flex; flex-direction: column; }
        .war-half { transition: height 0.1s ease-out; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 2.5rem; text-shadow: 0 0 15px rgba(0,0,0,0.7); width: 100%; overflow: hidden; }

        #bomb-circle { width: 180px; height: 180px; border-radius: 50%; border: 10px solid var(--danger); margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 4rem; font-weight: 900; box-shadow: 0 0 40px var(--danger); background: rgba(0,0,0,0.6); }
        .num-btn { background: #222; border: 1px solid #444; color: white; padding: 20px 30px; border-radius: 15px; font-size: 2rem; margin: 10px; }

        .card { width: 60px; height: 90px; background: white; color: black; border-radius: 8px; display: inline-flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; margin: 5px; font-size: 1.1rem; border: 1px solid #ccc; position: relative; }
        .card.back { background: var(--card-back); color: transparent; border: 2px solid #fff; }
        .card.red { color: #ff003c; }
        .card.shaieb { background: var(--danger); color: white; box-shadow: 0 0 10px red; }

        .xo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 90vw; max-width: 400px; margin: auto; }
        .cell { height: 120px; background: rgba(21, 21, 21, 0.8); border-radius: 20px; font-size: 3.5rem; display: flex; align-items: center; justify-content: center; border: 2px solid #222; }

        .ludo-board { display: grid; grid-template-columns: repeat(15, 1fr); grid-template-rows: repeat(15, 1fr); width: 95vw; max-width: 350px; aspect-ratio: 1/1; margin: 10px auto; background: #fff; border: 4px solid #333; position: relative; }
        .ludo-cell { border: 0.1px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; position: relative; }
        .l-red { background: #ff003c !important; } .l-green { background: #00ff00 !important; }
        .l-yellow { background: #ffcc00 !important; } .l-blue { background: #1e3799 !important; }
        .l-path { background: #eee; }
        .pawn-ludo { width: 80%; height: 80%; border-radius: 50%; position: absolute; z-index: 10; border: 2px solid #fff; box-shadow: 0 0 8px rgba(0,0,0,0.4); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #dice-val { display: inline-block; width: 50px; height: 50px; background: white; color: black; line-height: 50px; font-size: 1.8rem; font-weight: 900; border-radius: 10px; border: 3px solid var(--main); vertical-align: middle; }

        .hidden { display: none !important; }
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: black; padding: 25px 40px; border-radius: 25px; font-weight: 900; font-size: 1.4rem; z-index: 100005; text-align: center; border: 5px solid var(--main); line-height: 1.4; box-shadow: 0 0 100px rgba(0,0,0,0.8); }

        .side-container { 
            position: fixed; bottom: 85px; left: 15px; width: 300px; height: 420px; 
            background: rgba(0,0,0,0.92); border: 2.5px solid var(--main); border-radius: 25px; 
            z-index: 2000; display: flex; flex-direction: column; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            transform: translateX(-110%) scale(0.9);
            opacity: 0; transform-origin: left bottom; 
            backdrop-filter: blur(15px); box-shadow: 0 15px 50px rgba(0,0,0,0.8);
            pointer-events: none;
        }
        .side-container.open { transform: translateX(0) scale(1); opacity: 1; pointer-events: auto; }
        
        #chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 18px; font-size: 0.9rem; max-width: 85%; word-wrap: break-word; line-height: 1.4; animation: slideInFromLeft 0.3s ease forwards; }
        @keyframes slideInFromLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        
        .msg.me { background: var(--main); color: #000; align-self: flex-start; border-bottom-left-radius: 2px; font-weight: bold; text-align: right; }
        .msg.him { background: #222; color: #fff; align-self: flex-end; border-bottom-right-radius: 2px; border: 1px solid #444; text-align: right; }
        #chat-input-area { display: flex; padding: 15px; border-top: 1px solid #333; gap: 8px; }
        #chat-input { flex: 1; background: #151515; border: 1.5px solid #333; color: white; border-radius: 12px; padding: 10px; font-family: 'Cairo'; outline: none; }
        
        .side-toggle { position: fixed; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 2001; cursor: pointer; transition: 0.3s; font-size: 1.8rem; }
        
        #chat-toggle { bottom: 20px; left: 20px; background: var(--main); box-shadow: 0 0 20px rgba(0,255,0,0.4); }
        #quest-toggle { bottom: 20px; left: 90px; background: var(--shaieb); box-shadow: 0 0 20px rgba(255,204,0,0.4); }
        
        .side-toggle.new-msg { background: #ffcc00; animation: pulse 0.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .quest-item { background: #111; border: 1px solid #333; margin: 10px; padding: 15px; border-radius: 15px; text-align: right; }
        .quest-item h4 { margin: 0; color: var(--shaieb); font-size: 0.9rem; }
        .quest-item p { margin: 5px 0; font-size: 0.8rem; color: #ccc; }
        .claim-btn { background: #444; color: #888; border: none; padding: 6px 15px; border-radius: 10px; cursor: not-allowed; font-weight: bold; margin-top: 5px; width: 100%; transition: 0.3s; }
        .claim-btn.ready { background: var(--main); color: black; cursor: pointer; box-shadow: 0 0 10px var(--main); }
        .claim-btn.claimed { background: #222; color: #555; cursor: default; }
        
        .quest-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 0.8rem; padding: 3px 7px; border-radius: 50%; font-weight: bold; border: 2px solid #000; display: none; }

        #chat-pop-notif {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: var(--shaieb); color: #000; padding: 15px 35px; border-radius: 50px;
            font-weight: 900; z-index: 10002; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 40px rgba(255, 204, 0, 0.6); pointer-events: none;
            font-size: 1.3rem;
        }
        #chat-pop-notif.show { transform: translate(-50%, -50%) scale(1); }
    </style>
</head>
<body>

<div class="bg-panoramic"></div>
<audio id="bg-music" loop></audio>

<div id="player-stats-bar" class="hidden">
    <span style="color: var(--gold);">ğŸ’° <span id="my-gold-display">0</span></span>
    <span style="color: #0af;">â­ <span id="my-points-display">0</span></span>
</div>

<button id="store-btn" class="hidden" onclick="window.location.href='store.html'">ğŸ›’ Ø§Ù„Ù…ØªØ¬Ø±</button>
<div id="music-btn" class="hidden" onclick="toggleMusicModal()">Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ ğŸµ</div>

<div id="skills-overlay" class="hidden">
    <div id="skill-spy-btn" class="skill-use-btn hidden" onclick="useSkill('spy')" style="background: var(--shaieb);">ğŸ‘ï¸ <span class="skill-count" id="count-spy">0</span></div>
    <div id="skill-skip-btn" class="skill-use-btn hidden" onclick="useSkill('skip')" style="background: #f0f;">ğŸƒâ€â™‚ï¸ <span class="skill-count" id="count-skip">0</span></div>
    <div id="skill-freeze-btn" class="skill-use-btn hidden" onclick="useSkill('freeze')" style="background: #00f;">â„ï¸ <span class="skill-count" id="count-freeze">0</span></div>
    <div id="skill-erase-btn" class="skill-use-btn hidden" onclick="useSkill('erase')" style="background: #555;">ğŸ§½ <span class="skill-count" id="count-erase">0</span></div>
</div>

<div id="music-modal">
    <h3 style="color:var(--main); margin-bottom: 20px;">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª</h3>
    <div class="music-option" onclick="changeTrack('https://github.com/youssefzeweil1-source/Games1area/raw/refs/heads/main/%D8%AF%D9%8A%20%D8%AC%D9%8A%20%D8%B9%D9%85%D8%B1%20%D8%AD%D8%A7%D8%AD%D8%A7%20%D8%B1%D9%8A%D9%85%D9%83%D8%B3DJ%20Amr%207a7a%20Remix(MP3_160K).mp3', 'Ù…ÙˆØ³ÙŠÙ‚Ù‰ 1')">ØªØ´ØºÙŠÙ„: Ù…ÙˆØ³ÙŠÙ‚Ù‰ 1 ğŸµ</div>
    <div class="music-option" onclick="stopMusic()">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ â¹ï¸</div>
    <div onclick="toggleMusicModal()" style="color:#777; cursor:pointer; margin-top:15px; font-weight:bold;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
</div>

<div id="chat-pop-notif">Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©! âœ‰ï¸</div>

<div id="quest-toggle" class="side-toggle" onclick="toggleSidePanel('quest-container')">
    ğŸ“œ <span id="quest-notif-badge" class="quest-badge">0</span>
</div>
<div id="chat-toggle" class="side-toggle" onclick="toggleSidePanel('chat-container')">ğŸ’¬</div>

<div id="quest-container" class="side-container">
    <div style="padding:15px; background:var(--shaieb); color:black; font-weight:900; border-radius:20px 20px 0 0; display:flex; justify-content:space-between; align-items:center;">
        <span>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span>
        <span onclick="toggleSidePanel('quest-container')" style="cursor:pointer; font-size:1.5rem;">Ã—</span>
    </div>
    <div style="flex:1; overflow-y:auto; padding-bottom:10px;">
        <div class="quest-item">
            <h4>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h4>
            <p>Ø§Ø¯Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ (+40 Ø¬ÙˆÙ„Ø¯)</p>
            <button id="q-login-btn" class="claim-btn" onclick="claimDaily('login')">Ø­ØµÙˆÙ„</button>
        </div>
        <div class="quest-item">
            <h4>Ø§Ù„Ù…ØªØ­Ø¯Ø« Ø§Ù„Ø±Ø³Ù…ÙŠ</h4>
            <p>Ø£Ø±Ø³Ù„ Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª Ø§Ù„ÙŠÙˆÙ… (<span id="q-chat-prog">0/1</span>)</p>
            <button id="q-chat-btn" class="claim-btn" onclick="claimDaily('chat')">Ø­ØµÙˆÙ„</button>
        </div>
        <div class="quest-item">
            <h4>ØµØ§Ø¦Ø¯ Ø§Ù„Ø§Ù†ØªØµØ§Ø±Ø§Øª</h4>
            <p>ÙØ² ÙÙŠ Ø£ÙŠ Ø¬ÙˆÙ„Ø© Ø§Ù„Ø¢Ù† (<span id="q-win-prog">0/1</span>)</p>
            <button id="q-win-btn" class="claim-btn" onclick="claimDaily('win')">Ø­ØµÙˆÙ„</button>
        </div>
        <div class="quest-item">
            <h4>Ù…Ù‡Ù…Ø© Ø§Ù„ÙˆØ­Ø´</h4>
            <p>Ø­Ù‚Ù‚ 3 Ø§Ù†ØªØµØ§Ø±Ø§Øª Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (+100 Ø¬ÙˆÙ„Ø¯) (<span id="q-boss-prog">0/3</span>)</p>
            <button id="q-boss-btn" class="claim-btn" onclick="claimDaily('boss')">Ø­ØµÙˆÙ„</button>
        </div>
    </div>
</div>

<div id="chat-container" class="side-container">
    <div style="padding:15px; background:var(--main); color:black; font-weight:900; border-radius:20px 20px 0 0; display:flex; justify-content:space-between; align-items:center;">
        <span>C H A T</span>
        <span onclick="toggleSidePanel('chat-container')" style="cursor:pointer; font-size:1.5rem;">Ã—</span>
    </div>
    <div id="chat-messages"></div>
    <div id="chat-input-area">
        <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="if(event.key==='Enter') sendChat()">
        <button onclick="sendChat()" style="background:var(--main); border:none; border-radius:10px; padding:10px; cursor:pointer; font-weight:bold;">ğŸš€</button>
    </div>
</div>

<div id="setup" style="padding-top: 100px;">
    <h1 style="color:var(--main); font-size: 3.5rem; margin:0; letter-spacing: -2px; text-shadow: 0 0 20px var(--main);">ARENA âš¡</h1>
    <p style="color:#bbb;">made by ZEWEIL!</p>
    <input type="text" id="room" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©" style="padding:15px; border-radius:15px; border:1px solid #333; background:rgba(0,0,0,0.7); color:white; width:200px; text-align:center;"><br><br>
    <button class="btn-main" onclick="joinRoom()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø­Ø©</button>
</div>

<div id="lobby" class="hidden" style="padding-top: 50px;">
    <h2 style="color:var(--main)">ØºØ±ÙØ© Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ âš”ï¸</h2>
    <div id="p1-slot" class="player-slot">
        <div class="slot-top">
            <span>Ù„Ø§Ø¹Ø¨ 1</span>
            <span id="p1-ready" class="status-tag">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
        </div>
    </div>
    <div id="p2-slot" class="player-slot">
        <div class="slot-top">
            <span>Ù„Ø§Ø¹Ø¨ 2</span>
            <span id="p2-ready" class="status-tag">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
        </div>
    </div>
    <button id="ready-btn" class="btn-main" onclick="iamReady()" style="margin-top: 20px;">Ø£Ù†Ø§ Ù…Ø³ØªØ¹Ø¯! </button>
    <p id="lobby-wait-msg" style="color: #777; margin-top: 10px;">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø®ØµÙ… Ù„ØªØ¬Ù‡ÙŠØ² Ù†ÙØ³Ù‡...</p>
</div>

<div id="voting-screen" class="hidden" style="padding-top: 30px;">
    <h2 style="color:var(--shaieb)">ØµÙˆÙ‘ØªÙˆØ§ Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ù„Ø­Ù…Ø© ğŸ—³ï¸</h2>
    <div class="status-bar" id="status-bar-voting">
        <div id="st-p1">Ù„Ø§Ø¹Ø¨ 1: Ø¨ÙŠÙÙƒØ±..</div>
        <div id="st-p2">Ù„Ø§Ø¹Ø¨ 2: Ø¨ÙŠÙÙƒØ±..</div>
    </div>
    <div id="voting-area">
        <div class="vote-card" id="v-war" onclick="vote('war')"><img src="https://raw.githubusercontent.com/youssefzeweil1-source/Games1area/main/war.png" class="vote-img"><div class="vote-name">Ø§Ù„Ø³Ø±Ø¹Ø© âš¡</div></div>
        <div class="vote-card" id="v-sh" onclick="vote('sh')"><img src="https://raw.githubusercontent.com/youssefzeweil1-source/Games1area/main/sh.png" class="vote-img"><div class="vote-name">Ø§Ù„Ø´Ø§ÙŠØ¨ ğŸ¤¡</div></div>
        <div class="vote-card" id="v-bomb" onclick="vote('bomb')"><img src="https://raw.githubusercontent.com/youssefzeweil1-source/Games1area/main/bomb.png" class="vote-img"><div class="vote-name">Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© ğŸ’£</div></div>
        <div class="vote-card" id="v-xo" onclick="vote('xo')"><img src="https://raw.githubusercontent.com/youssefzeweil1-source/Games1area/main/xo.png" class="vote-img"><div class="vote-name">XO â­•</div></div>
        <div class="vote-card" id="v-ludo" onclick="vote('ludo')"><img src="https://raw.githubusercontent.com/youssefzeweil1-source/Games1area/main/ludo.png" class="vote-img"><div class="vote-name">Ù„ÙˆØ¯Ùˆ ğŸ²</div></div>
    </div>
</div>

<div id="game-ui" class="hidden">
    <div id="war-ui" class="hidden" style="width: 100%;">
        <div id="war-container" onclick="tapWar(event)">
            <div id="op-war" class="war-half" style="background:var(--danger); height:50%;">Ø§Ù„Ø¶Ø­ÙŠØ©</div>
            <div id="my-war" class="war-half" style="background:var(--main); height:50%;">Ø§Ù„ÙˆØ­Ø´</div>
        </div>
    </div>
    <div id="sh-ui" class="hidden">
        <h3 id="sh-stat" style="color:var(--shaieb); background: rgba(0,0,0,0.8); display: inline-block; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px;">...</h3>
        <div id="op-area"></div><div id="my-area" style="margin-top:30px;"></div>
    </div>
    <div id="bomb-ui" class="hidden">
        <h2 id="bomb-msg" style="text-shadow: 0 0 10px red;">Ø¯ÙˆØ± Ù…ÙŠÙ†ØŸ</h2>
        <div id="bomb-circle">0</div>
        <div id="bomb-btns">
            <button class="num-btn" onclick="addBomb(1)">+1</button>
            <button class="num-btn" onclick="addBomb(2)">+2</button>
            <button class="num-btn" onclick="addBomb(3)">+3</button>
        </div>
    </div>
    <div id="xo-ui" class="hidden">
        <h3 id="xo-stat" style="color:var(--main); background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 10px; margin-bottom: 20px;">...</h3>
        <div class="xo-grid" id="xo-board"></div>
    </div>
    <div id="ludo-ui" class="hidden">
        <h3 id="ludo-stat" style="color:var(--main); background: rgba(0,0,0,0.8); padding: 5px 15px; border-radius: 10px; margin-bottom: 10px;">Ù„ÙˆØ¯Ùˆ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ ğŸ²</h3>
        <div class="ludo-board" id="ludo-board"></div>
        <div style="margin-top:10px;"><div id="dice-val">?</div><button class="btn-main" onclick="rollLudo()" style="padding: 10px 25px;">Ø§Ø±Ù…ÙŠ ğŸ²</button></div>
    </div>
    <button onclick="clearRoom()" style="position: fixed; bottom: 10px; background:none; border:none; color:#555; text-decoration:underline; font-size: 0.7rem;">Ø³ÙˆÙØª ÙˆÙŠØ± ğŸ”„</button>
</div>

<div id="rematch-modal" class="hidden" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); padding: 30px; border-radius: 25px; border: 3px solid var(--shaieb); z-index: 200000; width: 80%; max-width: 400px; box-shadow: 0 0 100px rgba(255, 204, 0, 0.4);">
    <h2 id="rematch-title" style="color: var(--shaieb); margin-bottom: 10px;">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù„Ø­Ù…Ø©!</h2>
    <p id="rematch-status" style="color: #ccc;">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù… ÙÙŠ Ø¬ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰ØŸ</p>
    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
        <button id="rematch-yes" class="btn-main" onclick="voteRematch(true)" style="flex: 1; padding: 12px;">Ø¨Ù‚Ø§Ø¡ âš”ï¸</button>
        <button id="rematch-no" class="btn-main" onclick="voteRematch(false)" style="flex: 1; padding: 12px; background: var(--danger);">Ø§Ù†Ø³Ø­Ø§Ø¨ ğŸšª</button>
    </div>
    <div id="rematch-votes-display" style="margin-top: 15px; font-size: 0.9rem; color: var(--main);"></div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const messageSound = new Audio('https://github.com/youssefzeweil1-source/Games1area/raw/refs/heads/main/mixkit-software-interface-start-2574.wav');

    let rID, mID, rRef, uRef, myRole = "", canAction = true, rewardClaimed = false;
    const syms = { 'H': 'â™¡', 'D': 'â—‡', 'S': 'â™¤', 'C': 'â™§' };
    const gameNames = { 'war': 'Ø§Ù„Ø³Ø±Ø¹Ø© âš¡', 'sh': 'Ø§Ù„Ø´Ø§ÙŠØ¨ ğŸ¤¡', 'bomb': 'Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© ğŸ’£', 'xo': 'XO â­•', 'ludo': 'Ù„ÙˆØ¯Ùˆ ğŸ²' };
    const globalPath = [[6,0],[6,1],[6,2],[6,3],[6,4],[6,5],[5,6],[4,6],[3,6],[2,6],[1,6],[0,6],[0,7],[0,8],[1,8],[2,8],[3,8],[4,8],[5,8],[6,9],[6,10],[6,11],[6,12],[6,13],[6,14],[7,14],[8,14],[8,13],[8,12],[8,11],[8,10],[8,9],[9,8],[10,8],[11,8],[12,8],[13,8],[14,8],[14,7],[14,6],[13,6],[12,6],[11,6],[10,6],[9,6],[8,5],[8,4],[8,3],[8,2],[8,1],[8,0],[7,0]];
    const insults = ["ğŸ˜‚Ø¬Øª Ø§Ù„Ø­Ø²ÙŠÙ†Ù‡ ØªÙØ±Ø­ Ù…Ø§Ù„Ù‚ØªÙŠÙ„Ù‡Ø§Ø´ Ù…Ø·Ø±Ø±Ø­ ğŸ˜…", "Ø³Ø±Ø¹Ø© Ø³Ù„Ø­ÙØ§Ø© Ù…Ø´Ù„ÙˆÙ„Ø© ğŸ¢", "Ø§Ù„Ø¹Ø¨ Ø¨ØµØ¨Ø§Ø¹Ùƒ Ø§Ù„ØªØ§Ù†ÙŠ ÙŠÙ…ÙƒÙ† ØªÙÙ„Ø­ ğŸ¤¡", "Ø´ÙƒÙ„Ùƒ ÙˆØ­Ø´ Ø£ÙˆÙŠ Ù‚Ø¯Ø§Ù… Ø§Ù„Ø®ØµÙ… ğŸ’€", "Ø£Ù†Ø§ Ù„Ùˆ Ù…Ù†Ùƒ Ø£Ø±Ù…ÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ğŸš®", "Ø¬Øª ÙÙŠÙƒ ÙŠØ§ Ø®Ø§ÙŠØ¨! ğŸ’£", "Ø§Ù„Ø®ØµÙ… Ø¯Ø§Ø³ Ø¹Ù„ÙŠÙƒ Ø­Ø±ÙÙŠØ§Ù‹ ğŸ¦¶", "Ø¥ÙŠÙ‡ Ø§Ù„Ø¶Ø­Ùƒ Ø¯Ù‡? ğŸ˜‚"];
    const wins = ["Ø¬Ù„Ø¯ØªÙ‡ Ø¬Ù„Ø¯! ğŸ”¥", "Ù…Ø³ØªÙˆØ§Ùƒ Ø¹Ø§Ù„Ù…ÙŠ ÙŠØ§ ÙˆØ­Ø´ ğŸ¦", "Ø§Ù„Ø®ØµÙ… Ø¨ÙŠØ¹ÙŠØ· ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© ğŸ˜­", "Ø¥ÙŠÙ‡ Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø¯ÙŠ ÙŠØ§ Ù…Ù„Ùƒ! ğŸ‘‘", "Ø³Ù‡Ù„Ø© Ø£ÙˆÙŠ..  Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ø¯Ø¯Ø¯Ø¯Ø¯Ø¯Ø¯Ø¯Ù‡ ğŸ˜"];

    function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    function toggleSidePanel(id) {
        const target = document.getElementById(id);
        const isOpen = target.classList.contains('open');
        document.querySelectorAll('.side-container').forEach(c => c.classList.remove('open'));
        if (!isOpen) target.classList.add('open');
        if (id === 'chat-container') document.getElementById('chat-toggle').classList.remove('new-msg');
    }

    function updateQuestUI(user) {
        const today = new Date().toDateString();
        const quests = [
            { id: 'login', done: user.lastLogin === today, claimed: user.lastLoginClaim === today },
            { id: 'chat', done: user.lastChatDay === today, claimed: user.lastChatClaim === today },
            { id: 'win', done: user.tempWin === true, claimed: user.lastWinClaim === today },
            { id: 'boss', done: (user.totalWins || 0) >= 3, claimed: user.lastBossClaim === today }
        ];

        let readyCount = 0;
        quests.forEach(q => {
            const btn = document.getElementById(`q-${q.id}-btn`);
            const prog = document.getElementById(`q-${q.id}-prog`);
            
            if (q.id === 'boss') {
                if (prog) prog.innerText = `${Math.min(user.totalWins || 0, 3)}/3`;
            } else {
                if (prog) prog.innerText = q.done ? "1/1" : "0/1";
            }

            if (q.claimed) {
                btn.innerText = "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…"; btn.className = "claim-btn claimed"; btn.disabled = true;
            } else if (q.done) {
                btn.innerText = "Ø­ØµÙˆÙ„"; btn.className = "claim-btn ready"; btn.disabled = false;
                readyCount++;
            } else {
                btn.innerText = "Ø­ØµÙˆÙ„"; btn.className = "claim-btn"; btn.disabled = true;
            }
        });

        const badge = document.getElementById('quest-notif-badge');
        if (readyCount > 0) { badge.innerText = readyCount; badge.style.display = 'block'; }
        else { badge.style.display = 'none'; }
    }

    function claimDaily(type) {
        const today = new Date().toDateString();
        uRef.transaction(user => {
            if (!user) return;
            if (type === 'login' && user.lastLogin === today && user.lastLoginClaim !== today) {
                user.gold = (user.gold || 0) + 40; user.lastLoginClaim = today;
            } else if (type === 'chat' && user.lastChatDay === today && user.lastChatClaim !== today) {
                user.gold = (user.gold || 0) + 20; user.lastChatClaim = today;
            } else if (type === 'win' && user.tempWin === true && user.lastWinClaim !== today) {
                user.gold = (user.gold || 0) + 50; user.lastWinClaim = today; user.tempWin = false;
            } else if (type === 'boss' && (user.totalWins || 0) >= 3 && user.lastBossClaim !== today) {
                user.gold = (user.gold || 0) + 100; user.lastBossClaim = today;
            }
            return user;
        }, (err, comm) => { if(comm) showBigMsg("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©! ğŸ’°"); });
    }

    function giveReward(type) {
        if (!uRef || rewardClaimed) return;
        rewardClaimed = true; 
        uRef.transaction(user => {
            if (!user) user = { gold: 0, points: 0, skills: {}, totalWins: 0 };
            if (type === 'win') {
                user.gold = (user.gold || 0) + 50;
                user.totalWins = (user.totalWins || 0) + 1;
                user.tempWin = true; 
            }
            else if (type === 'draw') user.points = (user.points || 0) + 10;
            return user;
        }, (err, commit, snap) => {
            if(commit) {
                const data = snap.val();
                let msg = type === 'win' ? "Ù…Ø¨Ø±ÙˆÙƒ! +50 Ø¬ÙˆÙ„Ø¯ ğŸ’°" : "ØªØ¹Ø§Ø¯Ù„! +10 Ù†Ù‚Ø§Ø· â­";
                showBigMsg(msg);
            }
        });
    }

    function checkDailyLogin() {
        const today = new Date().toDateString();
        uRef.transaction(user => {
            if (user) {
                if (user.lastLogin !== today) {
                    user.lastLogin = today;
                    return user;
                }
            }
            return;
        });
    }

    function checkDailyChat() {
        const today = new Date().toDateString();
        uRef.transaction(user => {
            if (user) {
                if (user.lastChatDay !== today) {
                    user.lastChatDay = today;
                    return user;
                }
            }
            return;
        });
    }

    function useSkill(skillId) {
        if(!canAction) return;
        uRef.child('skills').transaction(skills => {
            if (skills && skills[skillId] > 0) {
                if (skillId === 'erase') {
                    rRef.child('xo').once('value', xoSnap => {
                        let d = xoSnap.val();
                        if (d && d.b && !d.win) {
                            let opSym = (myRole === 'p1' ? 'O' : 'X');
                            let lastIdx = d.b.lastIndexOf(opSym);
                            if (lastIdx !== -1) {
                                d.b[lastIdx] = ""; d.turn = myRole; 
                                rRef.child('xo').set(d);
                            } else { showBigMsg("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ù…Ø³Ø­Ù‡!"); return; }
                        }
                    });
                }
                skills[skillId] -= 1;
                rRef.child('active_skill').set({ type: skillId, by: myRole, time: Date.now() });
                return skills;
            }
            return skills;
        });
    }

    function toggleChat() { toggleSidePanel('chat-container'); }
    
    function sendChat() {
        const inp = document.getElementById('chat-input');
        if(!inp.value.trim() || !rRef) return;
        rRef.child('chat').push({ sender: myRole, text: inp.value.trim() });
        checkDailyChat(); inp.value = "";
    }

    function joinRoom() {
        rID = document.getElementById('room').value.trim();
        if(!rID) return alert("Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©!");
        mID = localStorage.getItem('arena_user_id') || ("U" + Math.floor(Math.random()*9999));
        localStorage.setItem('arena_user_id', mID);
        
        rRef = db.ref(`final_arena_v4/${rID}`);
        uRef = db.ref(`users/${mID}`);

        checkDailyLogin();

        rRef.child('slots').transaction(s => {
            if(!s) return { p1: mID };
            if(s.p1 === mID || s.p2 === mID) return s;
            if(!s.p2) return { p1: s.p1, p2: mID };
            return s;
        }, (err, comm, snap) => {
            const s = snap.val() || {};
            if (s.p1 !== mID && s.p2 !== mID && s.p1 && s.p2) { alert("Ø§Ù„ØºØ±ÙØ© ÙƒØ§Ù…Ù„Ø©!"); return; }
            
            myRole = (s.p1 === mID) ? "p1" : (s.p2 === mID ? "p2" : "viewer");
            
            if(myRole !== "viewer") {
                rRef.onDisconnect().remove(); 
            }

            document.getElementById('music-btn').classList.remove('hidden');
            document.getElementById('store-btn').classList.remove('hidden');
            document.getElementById('player-stats-bar').classList.remove('hidden');
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('lobby').classList.remove('hidden');
            listenStats();
            listenLobby();
        });
    }

    function listenStats() {
        uRef.on('value', snap => {
            const data = snap.val() || { gold: 0, points: 0, skills: {} };
            document.getElementById('my-gold-display').innerText = data.gold || 0;
            document.getElementById('my-points-display').innerText = data.points || 0;
            
            updateQuestUI(data); 

            const skills = data.skills || {};
            ['spy', 'skip', 'freeze', 'erase'].forEach(id => {
                const count = skills[id] || 0;
                const btn = document.getElementById(`skill-${id}-btn`);
                const counter = document.getElementById(`count-${id}`);
                if(btn && counter) {
                    counter.innerText = count;
                    if(count > 0) btn.classList.remove('hidden');
                    else btn.classList.add('hidden');
                }
            });
        });
    }

    function iamReady() {
        if(myRole === 'viewer') return;
        rRef.child(`ready/${myRole}`).set(true);
        document.getElementById('ready-btn').classList.add('hidden');
    }

    function handleGameOver(msg) {
        showBigMsg(msg);
        canAction = false;
        setTimeout(() => {
            document.getElementById('rematch-modal').classList.remove('hidden');
            document.getElementById('rematch-votes-display').innerText = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø±Ø§Ø± Ø§Ù„Ø®ØµÙ…...";
        }, 2000);
    }

    function listenLobby() {
        rRef.on('value', snap => {
            const d = snap.val();
            if (!d && myRole !== "viewer") { location.reload(); return; }
            
            const slots = d.slots || {};
            const ready = d.ready || {};
            const votes = d.votes || {};
            
            document.getElementById('p1-ready').innerText = ready.p1 ? "Ù…Ø³ØªØ¹Ø¯ âœ…" : (slots.p1 ? "Ø¨ÙŠØ¬Ù‡Ø² Ù†ÙØ³Ù‡.." : "ØºØ§Ø¦Ø¨");
            document.getElementById('st-p1').innerText = votes.p1 ? "Ù„Ø§Ø¹Ø¨ 1: " + gameNames[votes.p1] : "Ù„Ø§Ø¹Ø¨ 1: Ø¨ÙŠÙÙƒØ±..";
            document.getElementById('p2-ready').innerText = ready.p2 ? "Ù…Ø³ØªØ¹Ø¯ âœ…" : (slots.p2 ? "Ø¨ÙŠØ¬Ù‡Ø² Ù†ÙØ³Ù‡.." : "ØºØ§Ø¦Ø¨");
            document.getElementById('st-p2').innerText = votes.p2 ? "Ù„Ø§Ø¹Ø¨ 2: " + gameNames[votes.p2] : "Ù„Ø§Ø¹Ø¨ 2: Ø¨ÙŠÙÙƒØ±..";

            if (ready.p1 && ready.p2 && d.gameState !== 'playing') {
                document.getElementById('lobby').classList.add('hidden');
                document.getElementById('voting-screen').classList.remove('hidden');
            }
            if (votes.p1 && votes.p2 && votes.p1 === votes.p2 && d.gameState !== 'playing') {
                rRef.child('activeTab').set(votes.p1);
                rRef.child('gameState').set('playing');
            }
            if (d.gameState === 'playing') {
                document.getElementById('lobby').classList.add('hidden');
                document.getElementById('voting-screen').classList.add('hidden');
                document.getElementById('game-ui').classList.remove('hidden');
                document.getElementById('skills-overlay').classList.remove('hidden');
                updateSkillsVisibility(d.activeTab);
                initXO();
                drawLudoBoard();
                startListeners();
            }
        });

        rRef.child('active_skill').on('value', snap => {
            const skill = snap.val();
            if (!skill) return;
            if (skill.by === myRole) return; 

            const skillNames = {'freeze':'ØªØ¬Ù…ÙŠØ¯ â„ï¸', 'spy':'ØªØ¬Ø³Ø³ ğŸ‘ï¸', 'skip':'ØªØ®Ø·ÙŠ ğŸƒâ€â™‚ï¸', 'erase':'Ù…Ù…Ø­Ø§Ø© ğŸ§½'};
            showBigMsg(`Ø§Ù„Ø®ØµÙ… Ø§Ø³ØªØ®Ø¯Ù… Ù…Ù‡Ø§Ø±Ø©: ${skillNames[skill.type]}`);

            if (skill.type === 'freeze') {
                canAction = false;
                document.body.style.filter = "blur(4px) grayscale(1)";
                setTimeout(() => { canAction = true; document.body.style.filter = ""; }, 3000);
            }

            if (myRole === 'p1') {
                setTimeout(() => rRef.child('active_skill').remove(), 2000);
            }
        });

        rRef.child('chat').limitToLast(1).on('child_added', snap => {
            const m = snap.val();
            const div = document.createElement('div');
            div.className = `msg ${m.sender === myRole ? 'me' : 'him'}`;
            div.innerText = m.text;
            const box = document.getElementById('chat-messages');
            if(box) { box.appendChild(div); box.scrollTop = box.scrollHeight; }
            if(m.sender !== myRole) {
                messageSound.play().catch(e => {});
                document.getElementById('chat-toggle').classList.add('new-msg');
            }
        });

        rRef.child('rematch').on('value', snap => {
            const v = snap.val() || {};
            if (v.p1 && v.p2) {
                showBigMsg("Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªØ¨Ø¯Ø£ Ø§Ù„Ø¢Ù†! ğŸ”¥");
                setTimeout(() => { document.getElementById('rematch-modal').classList.add('hidden'); resetCurrentGame(); }, 1500);
            }
        });
    }

    function updateSkillsVisibility(game) {
        ['spy','skip','freeze','erase'].forEach(id => document.getElementById(`skill-${id}-btn`).style.display = 'none');
        if(game === 'sh') document.getElementById('skill-spy-btn').style.display = 'flex';
        if(game === 'bomb') document.getElementById('skill-skip-btn').style.display = 'flex';
        if(game === 'war') document.getElementById('skill-freeze-btn').style.display = 'flex';
        if(game === 'xo') document.getElementById('skill-erase-btn').style.display = 'flex';
    }

    function startListeners() {
        rRef.child('activeTab').on('value', s => {
            const t = s.val() || 'war';
            ['war','sh','bomb','xo','ludo'].forEach(id => document.getElementById(id+'-ui').classList.add('hidden'));
            document.getElementById(t+'-ui').classList.remove('hidden');
            updateSkillsVisibility(t);
        });

        rRef.child('war').on('value', s => {
            const d = s.val(); if(!d) return;
            const myH = (myRole==='p1'?d.p1:d.p2);
            document.getElementById('my-war').style.height = myH + "%";
            document.getElementById('op-war').style.height = (100-myH) + "%";
            if(d.status === 'done') {
                if(d.winner === myRole) giveReward('win');
                handleGameOver(d.winner === myRole ? getRandom(wins) : getRandom(insults));
            }
        });

        rRef.child('bomb').on('value', s => {
            const d = s.val() || {val:0, turn:'p1'};
            document.getElementById('bomb-circle').innerText = d.val;
            document.getElementById('bomb-msg').innerText = d.turn===myRole ? "Ø¯ÙˆØ±Ùƒ..Ø§ÙˆØ¹ÙŠ ØªÙØ¬Ø±Ù‡Ø§! ğŸ’£" : "Ø§Ø³ØªÙ†Ù‰ Ù„Ù…Ø§ ÙŠÙ†ÙØ¬Ø±ğŸ˜µâ€ğŸ’«";
            if(d.status === 'exploded') {
                if(d.turn !== myRole) giveReward('win');
                handleGameOver(d.turn===myRole ? getRandom(insults) : getRandom(wins));
            }
        });

        rRef.child('sh').on('value', s => {
            const d = s.val(); if(!d && myRole==='p1') setupSh(); else if(d) renderSh(d);
        });

        rRef.child('xo').on('value', s => {
            const d = s.val() || { b: Array(9).fill(""), turn: "p1" };
            const cells = document.querySelectorAll('.cell');
            d.b.forEach((v, i) => { if(cells[i]) { cells[i].innerText = v; cells[i].style.color = (v==='X'?'#0f0':'#f00'); } });
            if(d.win) {
                if(d.winRole===myRole) giveReward('win');
                handleGameOver(d.winRole===myRole ? getRandom(wins) : getRandom(insults));
            } else if(!d.b.includes("") && d.gameState !== 'readying') {
                giveReward('draw');
                handleGameOver("ØªØ¹Ø§Ø¯Ù„ Ø¹Ø§Ø¯Ù„! ğŸ¤");
            }
        });

        rRef.child('ludo').on('value', s => {
            const d = s.val() || { turn: 'p1', p1Pos: -1, p2Pos: -1 };
            document.getElementById('ludo-stat').innerText = d.turn === myRole ? "Ø¯ÙˆØ±Ùƒ.. Ø§Ø±Ù…ÙŠ Ø§Ù„Ù†Ø±Ø¯! ğŸ”¥" : "Ø§Ù„Ø®ØµÙ… Ø¨ÙŠÙ„Ø¹Ø¨..";
            document.querySelectorAll('.pawn-ludo').forEach(p => p.remove());
            if(d.p1Pos >= 0) renderPawn('p1', d.p1Pos);
            if(d.p2Pos >= 0) renderPawn('p2', (d.p2Pos + 26) % globalPath.length);
        });
    }

    function tapWar(event) {
        if(myRole==='viewer' || !canAction) return;
        rRef.child('war').transaction(d => {
            if(!d) d = {p1:50, p2:50, status:'playing'};
            if(d.status !== 'playing') return d;
            if(myRole==='p1') { d.p1 += 2; d.p2 -= 2; } else { d.p2 += 2; d.p1 -= 2; }
            if(d.p1 >= 100) { d.p1 = 100; d.p2 = 0; d.status = 'done'; d.winner = 'p1'; }
            if(d.p2 >= 100) { d.p2 = 100; d.p1 = 0; d.status = 'done'; d.winner = 'p2'; }
            return d;
        });
    }

    function addBomb(n) {
        rRef.child('bomb').once('value', s => {
            const d = s.val() || {val:0, limit: Math.floor(Math.random()*20)+40, turn:'p1'};
            if(d.turn !== myRole || d.status === 'exploded' || !canAction) return;
            let nv = d.val + n; let exp = nv >= d.limit;
            rRef.child('bomb').update({ val:nv, turn:(myRole==='p1'?'p2':'p1'), status:exp?'exploded':'playing', limit:d.limit });
        });
    }

    function setupSh() {
        const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        let deck = [];
        ['H','S','D','C'].forEach(s => ranks.forEach(r => deck.push({r, s})));
        deck.splice(Math.floor(Math.random() * 52), 1); deck.push({r:'SHAIEB', s:'ğŸ¤¡'});
        deck = deck.sort(() => Math.random() - 0.5);
        const removePairs = (arr) => {
            let counts = {}; arr.forEach(c => { if(c.r !== 'SHAIEB') counts[c.r] = (counts[c.r] || 0) + 1; });
            let result = []; let paired = {};
            arr.forEach(c => { if(c.r === 'SHAIEB') result.push(c); else if (counts[c.r] % 2 !== 0 && !paired[c.r]) { result.push(c); paired[c.r] = true; } });
            return result;
        };
        rRef.child('sh').set({ p1C: removePairs(deck.slice(0, 26)), p2C: removePairs(deck.slice(26)), turn: 'p1', status: 'playing' });
    }

    function renderSh(d) {
        const myC = (myRole==='p1'?d.p1C:d.p2C) || [], opC = (myRole==='p1'?d.p2C:d.p1C) || [];
        document.getElementById('sh-stat').innerText = (d.turn === myRole) ? "Ø§Ø³Ø­Ø¨ ÙˆØ±Ù‚Ø© Ù…Ù† Ø§Ù„Ø¶Ø­ÙŠØ©" : "Ø¨ÙŠØ³Ø­Ø¨ Ù…Ù†Ùƒ.. ÙŠØ§ Ø±Ø¨ Ù…ÙŠØ§Ø®Ø¯Ø´ Ø§Ù„Ø´Ø§ÙŠØ¨";
        const opB = document.getElementById('op-area'); opB.innerHTML = "";
        opC.forEach((c,i) => { 
            let v = document.createElement('div'); v.className="card back"; 
            rRef.child('active_skill').once('value', sk => {
                const s = sk.val();
                if(s && s.type === 'spy' && s.by === myRole && (Date.now() - s.time < 1500)) {
                    v.classList.remove('back');
                    v.classList.add('HD'.includes(c.s)?'red':'');
                    v.innerHTML = `<span>${c.r==='SHAIEB'?'ğŸ¤¡':c.r+syms[c.s]}</span>`;
                    setTimeout(() => { v.classList.add('back'); v.innerHTML=""; }, 1500);
                }
            });
            v.onclick=()=>pullSh(i); opB.appendChild(v); 
        });
        const myB = document.getElementById('my-area'); myB.innerHTML = "";
        myC.forEach(c => {
            let v = document.createElement('div'); v.className=`card ${'HD'.includes(c.s)?'red':''} ${c.r==='SHAIEB'?'shaieb':''}`;
            v.innerHTML = `<span>${c.r==='SHAIEB'?'ğŸ¤¡':c.r+syms[c.s]}</span>`; myB.appendChild(v);
        });
        if(myC.length === 0 && d.status === 'playing') {
            giveReward('win'); rRef.child('sh/status').set('done');
            handleGameOver("Ù‡Ø±Ø¨Øª Ø¨Ø§Ù„Ø³Ù„Ø§Ù…Ø©! " + getRandom(wins));
        }
    }

    function pullSh(idx) {
        if(!canAction) return; canAction = false;
        rRef.child('sh').once('value', s => {
            let d = s.val(); if(!d || d.turn !== myRole || d.status !== 'playing') { canAction=true; return; }
            let mk = (myRole==='p1'?'p1C':'p2C'), ok = (myRole==='p1'?'p2C':'p1C');
            let ma = [...(d[mk]||[])], oa = [...(d[ok]||[])];
            let pld = oa.splice(idx,1)[0];
            let pi = ma.findIndex(c => c.r === pld.r && c.r !== 'SHAIEB');
            if(pi !== -1) ma.splice(pi,1); else ma.push(pld);
            rRef.child('sh').update({ [mk]: ma, [ok]: oa, turn: (myRole==='p1'?'p2':'p1') }).then(() => setTimeout(() => canAction=true, 600));
        });
    }

    function initXO() {
        const b = document.getElementById('xo-board'); if(!b) return; b.innerHTML = "";
        for(let i=0; i<9; i++) { let v = document.createElement('div'); v.className="cell"; v.onclick=()=>tapXO(i); b.appendChild(v); }
    }
    function tapXO(i) {
        if(!canAction) return;
        rRef.child('xo').once('value', s => {
            let d = s.val() || { b: Array(9).fill(""), turn: "p1" };
            if(myRole !== d.turn || d.b[i] || d.win) return;
            d.b[i] = (myRole === 'p1') ? 'X' : 'O';
            const wns = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            wns.forEach(w => { if(d.b[w[0]] && d.b[w[0]]===d.b[w[1]] && d.b[w[0]]===d.b[w[2]]) { d.win=d.b[w[0]]; d.winRole=myRole; } });
            if(!d.win) d.turn = (myRole==='p1'?'p2':'p1');
            rRef.child('xo').update(d);
        });
    }

    function drawLudoBoard() {
        const b = document.getElementById('ludo-board'); if(!b) return; b.innerHTML = "";
        for (let r = 0; r < 15; r++) { for (let c = 0; c < 15; c++) {
            let cell = document.createElement('div'); cell.className = "ludo-cell"; cell.id = `cell-${r}-${c}`;
            if (r < 6 && c < 6) cell.classList.add('l-red'); else if (r < 6 && c > 8) cell.classList.add('l-green');
            else if (r > 8 && c < 6) cell.classList.add('l-yellow'); else if (r > 8 && c > 8) cell.classList.add('l-blue');
            globalPath.forEach(p => { if(p[0] === r && p[1] === c) cell.classList.add('l-path'); });
            b.appendChild(cell);
        }}
    }

    function rollLudo() {
        if(myRole === 'viewer' || !canAction) return;
        rRef.child('ludo').once('value', s => {
            let d = s.val() || { turn: 'p1', p1Pos: -1, p2Pos: -1 };
            if (d.turn !== myRole) return;
            let r = Math.floor(Math.random() * 6) + 1;
            document.getElementById('dice-val').innerText = r;
            if (myRole === 'p1') { if (d.p1Pos === -1 && r === 6) d.p1Pos = 0; else if (d.p1Pos >= 0) d.p1Pos += r; }
            else { if (d.p2Pos === -1 && r === 6) d.p2Pos = 0; else if (d.p2Pos >= 0) d.p2Pos += r; }
            if (d.p1Pos >= 51 || d.p2Pos >= 51) { giveReward('win'); handleGameOver(myRole === 'p1' ? getRandom(wins) : getRandom(insults)); }
            else { d.turn = (myRole === 'p1' ? 'p2' : 'p1'); rRef.child('ludo').update(d); }
        });
    }

    function renderPawn(role, posIdx) {
        const coords = globalPath[posIdx]; if(!coords) return;
        const cell = document.getElementById(`cell-${coords[0]}-${coords[1]}`);
        if(cell) { let p = document.createElement('div'); p.className = `pawn-ludo`; p.style.background = (role === 'p1') ? '#0f0' : '#f00'; cell.appendChild(p); }
    }

    function vote(game) {
        if (myRole === 'viewer') return;
        rRef.child('votes').update({ [myRole]: game });
        document.querySelectorAll('.vote-card').forEach(el => el.classList.remove('selected'));
        document.getElementById('v-' + game).classList.add('selected');
    }

    function voteRematch(stay) {
        if (myRole === 'viewer') return;
        if (!stay) { rRef.child('rematch').remove(); location.reload(); return; }
        rRef.child(`rematch/${myRole}`).set(true);
    }

    function resetCurrentGame() {
        canAction = true; rewardClaimed = false; 
        if (myRole !== 'p1') return;
        rRef.child('activeTab').once('value', s => {
            const game = s.val(); const up = { rematch: null, gameState: 'playing' };
            if (game === 'war') up.war = {p1:50, p2:50, status:'playing'};
            if (game === 'bomb') up.bomb = {val:0, limit: Math.floor(Math.random()*20)+40, turn:'p1', status:'playing'};
            if (game === 'xo') up.xo = { b: Array(9).fill(""), turn: "p1" };
            if (game === 'sh') rRef.child('sh').remove();
            if (game === 'ludo') up.ludo = { turn: 'p1', p1Pos: -1, p2Pos: -1 };
            rRef.update(up);
        });
    }

    function showBigMsg(txt) {
        const t = document.createElement('div'); t.className='toast'; t.innerText=txt;
        document.body.appendChild(t); setTimeout(()=>t.remove(), 2500);
    }

    function toggleMusicModal() { document.getElementById('music-modal').classList.toggle('open'); }
    function changeTrack(url, name) {
        const music = document.getElementById('bg-music'); music.src = url; music.play();
        toggleMusicModal(); showBigMsg("ØªÙ… ØªØ´ØºÙŠÙ„: " + name);
    }
    function stopMusic() { document.getElementById('bg-music').pause(); toggleMusicModal(); }
    function clearRoom() { if(confirm("ØªØµÙÙŠØ± Ø´Ø§Ù…Ù„ØŸ")) { rRef.remove(); location.reload(); } }
</script>
</body>
</html>
