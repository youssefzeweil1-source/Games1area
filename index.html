<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Games1area | Stable Version ğŸ®</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --main: #0f0; --shaieb: #ffcc00; --bg: #0d0d0d; --danger: #ff4d4d; }
        body { background: var(--bg); color: white; font-family: 'Cairo', sans-serif; margin: 0; text-align: center; user-select: none; overflow-x: hidden; }
        
        /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø®ØªÙØ§Ø¡ */
        .hidden { display: none !important; }

        #setup { padding: 80px 20px; }
        .input-style { padding: 15px; border-radius: 12px; border: 1px solid #333; width: 250px; background: #1a1a1a; color: #fff; text-align: center; outline: none; }
        .btn-main { background: var(--main); color: #000; border: none; padding: 15px 40px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        
        .tabs { display: flex; max-width: 400px; margin: 20px auto; background: #1a1a1a; border-radius: 50px; padding: 5px; border: 1px solid #333; }
        .tab { flex: 1; padding: 12px; cursor: pointer; font-weight: bold; color: #777; border-radius: 50px; }
        .tab.active { color: #000; background: var(--main); }

        .card { width: 65px; height: 95px; background: white; color: black; border-radius: 10px; display: inline-flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; margin: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); cursor: pointer; border: 1px solid #ddd; transition: 0.2s; }
        .card.red { color: #d63031; }
        .card.back { background: linear-gradient(135deg, #1e3799, #0c2461); border: 2px solid #fff; color: transparent; }
        .card.shaieb { background: var(--danger); color: white; animation: shake 0.5s infinite; border: 2px solid #fff; }
        .card.disabled { opacity: 0.6; cursor: not-allowed; }

        @keyframes shake { 0%,100% {transform:rotate(0)} 25% {transform:rotate(4deg)} 75% {transform:rotate(-4deg)} }
        
        .toast { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); padding: 20px 40px; border-radius: 15px; font-weight: bold; z-index: 10001; background: var(--shaieb); color: #000; border: 3px solid #000; animation: bounceIn 0.5s; pointer-events: none; width: 80%; max-width: 300px; }
        @keyframes bounceIn { 0% { transform: translate(-50%, -80%) scale(0.5); opacity: 0; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

        .xo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 300px; margin: auto; }
        .cell { height: 90px; background: #151515; border-radius: 15px; font-size: 2.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #222; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ØµÙ„Ø­ */
        #chat-box { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 10000; display: flex; flex-direction: column; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 1rem; }
        .msg.me { align-self: flex-start; background: var(--main); color: #000; }
        .msg.him { align-self: flex-end; background: #333; color: #fff; }
        .chat-input-area { padding: 15px; background: #1a1a1a; display: flex; gap: 10px; }
        #chat-in { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #444; background: #000; color: #fff; outline: none; }
        .btn-send { background: var(--main); color: #000; border: none; padding: 0 20px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        #btn-chat-toggle { position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--main); border: none; font-size: 25px; cursor: pointer; z-index: 5000; box-shadow: 0 0 15px var(--main); }
    </style>
</head>
<body>

<div id="setup">
    <h1 style="color:var(--main); font-size: 2.5rem;">Games1area ğŸ®</h1>
    <p style="color: #888;">Stable Build v2.0</p>
    <input type="text" id="room" class="input-style" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©"><br><br>
    <button class="btn-main" onclick="joinRoom()">Ø¯Ø®ÙˆÙ„ Ø§Ù„ØºØ±ÙØ©</button>
</div>

<div id="game-ui" class="hidden">
    <div class="tabs">
        <div id="t-xo" class="tab active" onclick="switchUI('xo')">X-O</div>
        <div id="t-sh" class="tab" onclick="switchUI('sh')">Ø§Ù„Ø´Ø§ÙŠØ¨ ğŸ¤¡</div>
    </div>

    <div id="xo-ui">
        <h3 id="xo-stat" style="color:var(--main)">...</h3>
        <div class="xo-grid" id="xo-board"></div>
    </div>

    <div id="sh-ui" class="hidden">
        <h3 id="sh-stat" style="color:var(--shaieb)">...</h3>
        <div id="op-area" style="min-height:120px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin: 10px;"></div>
        <div style="margin: 10px 0; color:#666; font-size:0.8rem;">ÙˆØ±Ù‚Ùƒ Ø£Ù†Øª (Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„ØºØ´ ğŸ¤«)</div>
        <div id="my-area" style="min-height:120px; padding: 10px;"></div>
    </div>

    <button id="btn-chat-toggle" onclick="toggleChat()">ğŸ’¬</button>

    <div id="chat-box" class="hidden">
        <div style="padding: 15px; background: #222; display: flex; justify-content: space-between; align-items: center;">
            <b style="color:var(--main)">Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØªØ­Ø¯ÙŠ ğŸ’¬</b>
            <button onclick="toggleChat()" style="background:#ff4d4d; border:none; color:white; padding: 5px 15px; border-radius: 5px; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚ Ã—</button>
        </div>
        <div id="chat-msgs"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-in" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="btn-send" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <button onclick="clearRoom()" style="margin-top:30px; color:var(--danger); background:none; border:none; cursor:pointer; text-decoration: underline;">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ğŸ”„</button>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let rID, mID, rRef, myRole = ""; 
    let canAction = true;
    const syms = { 'H': 'â™¡', 'D': 'â—‡', 'S': 'â™¤', 'C': 'â™§' };
    const insults = ["ÙŠØ§ Ø¨Ø·Ù„! ğŸ€", "Ø§Ù„Ø´Ø§ÙŠØ¨ Ø¬Ø§ÙŠÙ„Ùƒ! ğŸ¤¡", "ÙØ®! ğŸ’€", "Ø®Ø¯ Ø¯ÙŠ! ğŸ˜ˆ"];

    function showMsg(txt) {
        const old = document.querySelector('.toast'); if(old) old.remove();
        const t = document.createElement('div'); t.className = 'toast';
        t.innerText = txt; document.body.appendChild(t);
        setTimeout(() => { if(t) t.remove(); }, 2500);
    }

    function toggleChat() {
        const chat = document.getElementById('chat-box');
        chat.classList.toggle('hidden');
        if(!chat.classList.contains('hidden')) {
            document.getElementById('btn-chat-toggle').style.background = '#0f0';
            document.getElementById('chat-in').focus();
        }
    }

    function sendChat() {
        const inp = document.getElementById('chat-in');
        const txt = inp.value.trim();
        if(!txt || !rRef) return;
        rRef.child('chat').push({ sender: myRole, text: txt });
        inp.value = "";
    }

    function joinRoom() {
        rID = document.getElementById('room').value.trim();
        if(!rID) return alert("Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯!");
        mID = "U" + Math.floor(Math.random()*9999);
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        rRef = db.ref(`pro_version_v15/${rID}`);

        rRef.child('slots').transaction(s => {
            if(!s) return { p1: mID };
            if(!s.p2 && s.p1 !== mID) return { p1: s.p1, p2: mID };
            return s;
        }, (err, committed, snap) => {
            const s = snap.val();
            myRole = (s.p1 === mID) ? "p1" : (s.p2 === mID ? "p2" : "viewer");
            initXO();
            startListeners();
            
            rRef.child('chat').on('child_added', snap => {
                const msg = snap.val();
                const div = document.createElement('div');
                div.className = `msg ${msg.sender === myRole ? 'me' : 'him'}`;
                div.innerText = msg.text;
                const container = document.getElementById('chat-msgs');
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
                if(msg.sender !== myRole && document.getElementById('chat-box').classList.contains('hidden')) {
                    document.getElementById('btn-chat-toggle').style.background = '#ff4d4d';
                }
            });
        });
    }

    function initXO() {
        const board = document.getElementById('xo-board'); board.innerHTML = "";
        for(let i=0; i<9; i++) {
            let div = document.createElement('div'); div.className = "cell";
            div.onclick = () => tapXO(i); board.appendChild(div);
        }
    }

    function startListeners() {
        rRef.child('activeTab').on('value', s => {
            const t = s.val() || 'xo';
            document.getElementById('xo-ui').classList.toggle('hidden', t !== 'xo');
            document.getElementById('sh-ui').classList.toggle('hidden', t !== 'sh');
            document.getElementById('t-xo').classList.toggle('active', t === 'xo');
            document.getElementById('t-sh').classList.toggle('active', t === 'sh');
        });

        rRef.child('xo').on('value', s => {
            const d = s.val() || { b: Array(9).fill(""), turn: "p1", win: false };
            const cells = document.querySelectorAll('.cell');
            d.b.forEach((v, i) => { cells[i].innerText = v; cells[i].style.color = (v==='X'?'#0f0':'#f00'); });
            document.getElementById('xo-stat').innerText = d.win ? `Ø§Ù„ÙØ§Ø¦Ø² ${d.win} ğŸ†` : (myRole === d.turn ? "Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù†" : "Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø®ØµÙ…..");
        });

        rRef.child('sh').on('value', s => {
            const d = s.val();
            if(!d && myRole === 'p1') setupSh();
            else if(d) {
                renderSh(d);
                if(d.lastMsg && d.msgID !== window.lastMsgID) {
                    showMsg(d.lastMsg);
                    window.lastMsgID = d.msgID;
                }
            }
        });
    }

    function setupSh() {
        let pool = ['A','2','3','4','5','6','7','8','9','10'];
        let cards = [];
        pool.forEach(r => { cards.push({r, s:'H'}, {r, s:'S'}); });
        cards = cards.sort(() => Math.random() - 0.5);
        let p1 = cards.slice(0, 10), p2 = cards.slice(10, 20);
        p1.push({r:'SHAIEB', s:'ğŸ¤¡'});
        rRef.child('sh').set({ p1C: p1, p2C: p2, turn: 'p1', lastMsg: "Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª!" });
    }

    function renderSh(d) {
        const myC = (myRole === 'p1' ? d.p1C : d.p2C) || [];
        const opC = (myRole === 'p1' ? d.p2C : d.p1C) || [];
        const isTurn = (d.turn === myRole);
        document.getElementById('sh-stat').innerText = isTurn ? "Ø§Ø³Ø­Ø¨ ÙˆØ±Ù‚Ø©.." : "ØµØ§Ø­Ø¨Ùƒ Ø¨ÙŠØ³Ø­Ø¨..";
        
        const opB = document.getElementById('op-area'); opB.innerHTML = "";
        opC.forEach((_, i) => {
            let div = document.createElement('div');
            div.className = "card back" + (isTurn ? "" : " disabled");
            div.onclick = () => pullSh(i);
            opB.appendChild(div);
        });

        const myB = document.getElementById('my-area'); myB.innerHTML = "";
        myC.forEach(c => {
            let div = document.createElement('div');
            div.className = `card ${'HD'.includes(c.s)?'red':''} ${c.r==='SHAIEB'?'shaieb':''}`;
            div.innerHTML = `<span>${c.r==='SHAIEB'?'':c.r}</span><span style="font-size:22px">${c.r==='SHAIEB'?'ğŸ¤¡':syms[c.s]}</span>`;
            myB.appendChild(div);
        });

        if (myC.length === 0 && opC.length > 0) { alert("ğŸ‰ ÙØ²Øª!"); clearRoom(); }
        else if (myC.length === 1 && myC[0].r === 'SHAIEB' && opC.length === 0) { alert("ğŸ¤¡ Ù„Ø¨Ø³Øª Ø§Ù„Ø´Ø§ÙŠØ¨!"); clearRoom(); }
    }

    function pullSh(idx) {
        if(!canAction) return;
        rRef.child('sh').once('value', s => {
            let d = s.val();
            if(!d || d.turn !== myRole) return;
            canAction = false; 
            let myKey = (myRole === 'p1' ? 'p1C' : 'p2C'), opKey = (myRole === 'p1' ? 'p2C' : 'p1C');
            let myArr = [...(d[myKey] || [])], opArr = [...(d[opKey] || [])];
            if(opArr.length === 0) { canAction = true; return; }
            let card = opArr.splice(idx, 1)[0];
            myArr.push(card);
            let counts = {}; myArr.forEach(c => counts[c.r] = (counts[c.r] || 0) + 1);
            let hasPair = myArr.length > (myArr.filter(c => c.r === 'SHAIEB' || counts[c.r] % 2 !== 0).length);
            let cleaned = myArr.filter(c => c.r === 'SHAIEB' || counts[c.r] % 2 !== 0);
            const msg = insults[Math.floor(Math.random() * insults.length)];
            let up = {}; up[myKey] = cleaned; up[opKey] = opArr; up['turn'] = (myRole === 'p1' ? 'p2' : 'p1');
            up['lastMsg'] = hasPair ? "âœ¨ Ø·ÙŠØ± Ø²ÙˆØ¬! Ùˆ " + msg : msg;
            up['msgID'] = Math.random();
            rRef.child('sh').update(up).then(() => { setTimeout(() => { canAction = true; }, 800); });
        });
    }

    function tapXO(i) {
        rRef.child('xo').once('value', s => {
            const d = s.val() || { b: Array(9).fill(""), turn: "p1", win: false };
            if(myRole !== d.turn || d.b[i] || d.win) return;
            d.b[i] = (myRole === 'p1') ? 'X' : 'O';
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for(let w of wins) if(d.b[w[0]] && d.b[w[0]]===d.b[w[1]] && d.b[w[0]]===d.b[w[2]]) d.win = d.b[w[0]];
            if(!d.win) d.turn = (myRole === 'p1') ? 'p2' : 'p1';
            rRef.child('xo').update(d);
        });
    }

    function switchUI(t) { rRef.update({ activeTab: t }); }
    function clearRoom() { if(confirm("Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ")) { rRef.remove(); location.reload(); } }
</script>
</body>
</html>
