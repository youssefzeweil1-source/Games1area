<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arena Ultra | Panoramic Edition âš¡</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root { --main: #00f2ff; --pink: #ff007a; --bg: #080808; --danger: #ff003c; --shaieb: #ffcc00; --card-back: #1e3799; }
        
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Cairo', sans-serif; background: #000; color: white; }

        /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø§Ù†ÙˆØ±Ø§Ù…ÙŠØ© (ØµÙˆØ±ØªÙƒ Ù…Ù† GitHub) */
        .bg-panoramic {
            position: fixed; top: 0; left: 0; width: 300%; height: 100%;
            background: url('https://raw.githubusercontent.com/youssefzeweil1-source/Games1area/main/bg.png') repeat-x;
            background-size: cover; z-index: -1;
            animation: moveBg 40s linear infinite alternate;
            filter: brightness(0.5) contrast(1.2);
        }
        @keyframes moveBg { from { transform: translateX(0); } to { transform: translateX(-66%); } }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .screen { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; transition: 0.5s; backdrop-filter: blur(10px); }
        .hidden { display: none !important; }

        /* Ø§Ù„ØªØµÙˆÙŠØª ÙˆØ§Ù„Ù„ÙˆØ¨ÙŠ */
        .glass-card { background: rgba(0,0,0,0.85); padding: 30px; border-radius: 25px; border: 2px solid var(--main); text-align: center; box-shadow: 0 0 30px rgba(0,242,255,0.2); width: 85%; max-width: 400px; }
        .vote-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .vote-item { position: relative; border-radius: 15px; border: 2px solid #333; height: 110px; overflow: hidden; cursor: pointer; transition: 0.3s; }
        .vote-item img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        .vote-item.selected { border-color: var(--main); transform: scale(1.05); box-shadow: 0 0 15px var(--main); }
        .vote-item.selected img { opacity: 1; }
        .vote-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.8); font-size: 0.8rem; font-weight: 900; padding: 5px 0; }

        /* Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ (Ø³ØªØ§ÙŠÙ„ Ù‚Ø¯ÙŠÙ… Ù…Ø­Ø³Ù†) */
        #war-container { width: 90%; height: 400px; border: 4px solid #222; border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; }
        .war-half { transition: height 0.1s linear; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.5rem; }
        .card { width: 50px; height: 75px; background: white; color: black; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin: 3px; font-size: 0.9rem; border: 1px solid #ccc; }
        .card.back { background: var(--card-back); color: transparent; border: 2px solid #fff; }
        .card.red { color: #ff003c; }
        .card.shaieb { background: var(--danger); color: white; box-shadow: 0 0 10px red; }
        .xo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 280px; margin: auto; }
        .cell { height: 80px; background: rgba(255,255,255,0.1); border-radius: 15px; font-size: 2.5rem; display: flex; align-items: center; justify-content: center; border: 2px solid #222; }

        /* UI */
        .btn-main { background: var(--main); color: #000; border: none; padding: 15px 40px; border-radius: 50px; font-weight: 900; cursor: pointer; }
        .input-box { padding: 15px; border-radius: 15px; border: 1px solid #444; background: #000; color: #fff; text-align: center; width: 80%; margin-bottom: 20px; }
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: black; padding: 25px; border-radius: 20px; font-weight: 900; z-index: 10000; border: 4px solid var(--main); }
    </style>
</head>
<body>

<div class="bg-panoramic"></div>

<div id="screen-join" class="screen">
    <div class="glass-card">
        <h1 style="color:var(--main); margin:0;">ARENA âš¡</h1>
        <p style="color:#aaa;">Ø§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø®ØµÙ…</p>
        <input type="text" id="room-id" class="input-box" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
        <button class="btn-main" onclick="joinRoom()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© ğŸ”¥</button>
    </div>
</div>

<div id="screen-lobby" class="screen hidden">
    <div class="glass-card">
        <h2 style="animation: pulse 1s infinite alternate;">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø®ØµÙ…...</h2>
        <div style="margin: 20px 0; color: var(--main); font-weight: 900;">ID: <span id="display-id"></span></div>
        <p style="font-size: 0.8rem;">Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ØªØ§Ù†ÙŠ ÙŠØ¯Ø®Ù„ Ù‡Ù†Ø¨Ø¯Ø£ Ø§Ù„ØªØµÙˆÙŠØª ÙÙˆØ±Ø§Ù‹</p>
    </div>
</div>

<div id="screen-vote" class="screen hidden">
    <h2 style="text-shadow: 0 0 10px var(--main);">Ø§Ø®ØªØ± Ù…Ø§Ø¨ Ø§Ù„Ù„Ø¹Ø¨ ğŸ—ºï¸</h2>
    <div class="vote-grid">
        <div class="vote-item" onclick="submitVote('war')">
            <img src="https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=200">
            <div class="vote-label">Ø§Ù„Ø³Ø±Ø¹Ø© âš¡</div>
        </div>
        <div class="vote-item" onclick="submitVote('bomb')">
            <img src="https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?w=200">
            <div class="vote-label">Ø§Ù„Ù‚Ù†Ø¨Ù„Ø© ğŸ’£</div>
        </div>
        <div class="vote-item" onclick="submitVote('sh')">
            <img src="https://images.unsplash.com/photo-1596448332613-241073d44e4a?w=200">
            <div class="vote-label">Ø§Ù„Ø´Ø§ÙŠØ¨ ğŸ¤¡</div>
        </div>
        <div class="vote-item" onclick="submitVote('xo')">
            <img src="https://images.unsplash.com/photo-1611996575749-79a3a250f948?w=200">
            <div class="vote-label">XO â­•</div>
        </div>
    </div>
    <p id="vote-status" style="margin-top:20px; color:var(--pink);">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± ØªØµÙˆÙŠØª Ø§Ù„Ø®ØµÙ…...</p>
</div>

<div id="screen-game" class="screen hidden" style="backdrop-filter: none; background: rgba(0,0,0,0.7);">
    <div id="war-ui" class="hidden" style="width:100%">
        <div id="war-container" onclick="tapWar()">
            <div id="op-war" class="war-half" style="background:var(--danger); height:50%;">Ø§Ù„Ø¶Ø­ÙŠØ©</div>
            <div id="my-war" class="war-half" style="background:var(--main); height:50%;">Ø§Ù„ÙˆØ­Ø´</div>
        </div>
    </div>
    <div id="bomb-ui" class="hidden">
        <h2 id="bomb-msg">Ø¯ÙˆØ± Ù…ÙŠÙ†ØŸ</h2>
        <div id="bomb-circle" style="width:140px; height:140px; border:8px solid var(--danger); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:3rem; font-weight:900; margin:20px auto;">0</div>
        <button class="btn-main" style="margin:5px;" onclick="addBomb(1)">+1</button>
        <button class="btn-main" style="margin:5px;" onclick="addBomb(2)">+2</button>
    </div>
    <div id="sh-ui" class="hidden">
        <h3 id="sh-stat" style="color:var(--shaieb)">...</h3>
        <div id="op-area"></div><div id="my-area" style="margin-top:20px;"></div>
    </div>
    <div id="xo-ui" class="hidden">
        <h3 id="xo-stat" style="color:var(--main)">...</h3>
        <div class="xo-grid" id="xo-board"></div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let rID, mID, rRef, myRole, canAction = true;
    const syms = { 'H': 'â™¡', 'D': 'â—‡', 'S': 'â™¤', 'C': 'â™§' };

    function joinRoom() {
        rID = document.getElementById('room-id').value.trim();
        if(!rID) return;
        mID = "U" + Math.floor(Math.random()*9999);
        rRef = db.ref(`arena_v7/${rID}`);
        document.getElementById('display-id').innerText = rID;

        rRef.child('slots').transaction(s => {
            if(!s) return { p1: mID };
            if(!s.p2 && s.p1 !== mID) return { p1: s.p1, p2: mID };
            return s;
        }, (err, comm, snap) => {
            myRole = (snap.val().p1 === mID) ? "p1" : "p2";
            showScreen('screen-lobby');
            rRef.child(`slots/${myRole}`).onDisconnect().remove();
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø®ØµÙ…
            rRef.child('slots').on('value', ss => {
                if(ss.val()?.p1 && ss.val()?.p2) setTimeout(() => showScreen('screen-vote'), 2000);
            });

            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØµÙˆÙŠØª
            rRef.child('finalGame').on('value', ss => {
                if(ss.val()) startGame(ss.val());
            });

            startSync();
        });
    }

    function submitVote(game) {
        rRef.child(`votes/${myRole}`).set(game);
        document.querySelectorAll('.vote-item').forEach(i => i.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
        
        rRef.child('votes').once('value', ss => {
            const v = ss.val();
            if(v && v.p1 && v.p2) {
                // Ù„Ùˆ Ø§Ù„Ø§ØªÙ†ÙŠÙ† ØµÙˆØªÙˆØ§ØŒ p1 Ø¨ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©
                if(myRole === 'p1') rRef.child('finalGame').set(v.p1); 
            }
        });
    }

    function startGame(game) {
        showScreen('screen-game');
        document.getElementById(game + '-ui').classList.remove('hidden');
        if(game === 'xo') initXO();
    }

    function startSync() {
        // Ù„ÙˆØ¬ÙŠÙƒ Ø­Ø±Ø¨ Ø§Ù„Ø³Ø±Ø¹Ø©
        rRef.child('war').on('value', s => {
            const d = s.val() || {p1:50, p2:50};
            document.getElementById('my-war').style.height = (myRole==='p1'?d.p1:d.p2) + "%";
            document.getElementById('op-war').style.height = (myRole==='p1'?d.p2:d.p1) + "%";
            if(d.p1 >= 100 || d.p2 >= 100) { showBigMsg("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¹Ø±ÙƒØ©!"); rRef.child('war').set({p1:50, p2:50}); }
        });

        // Ù„ÙˆØ¬ÙŠÙƒ Ø§Ù„Ù‚Ù†Ø¨Ù„Ø©
        rRef.child('bomb').on('value', s => {
            const d = s.val() || {val:0, turn:'p1'};
            document.getElementById('bomb-circle').innerText = d.val;
            document.getElementById('bomb-msg').innerText = d.turn===myRole ? "Ø¯ÙˆØ±Ùƒ.. Ø­Ø§Ø³Ø¨! ğŸ’£" : "Ø§Ø³ØªÙ†Ù‰ Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø± ğŸ˜‚";
            if(d.status === 'exploded') showBigMsg("Ø¨ÙˆÙ…! Ø±Ø§Ø­Øª Ø¹Ù„ÙŠÙƒ");
        });

        // Ù„ÙˆØ¬ÙŠÙƒ Ø§Ù„Ø´Ø§ÙŠØ¨
        rRef.child('sh').on('value', s => {
            const d = s.val();
            if(!d && myRole==='p1') setupSh();
            else if(d) renderSh(d);
        });

        // Ù„ÙˆØ¬ÙŠÙƒ XO
        rRef.child('xo').on('value', s => {
            const d = s.val() || { b: Array(9).fill(""), turn: "p1" };
            const cells = document.querySelectorAll('.cell');
            d.b.forEach((v, i) => { cells[i].innerText = v; cells[i].style.color = (v==='X'?'#00f2ff':'#ff007a'); });
            if(d.win) showBigMsg("ÙÙˆØ² Ù…Ø³ØªØ­Ù‚!");
        });
    }

    // Ø§Ù„Ø£ÙƒØ´Ù†Ø² (Ù…Ø³ØªÙˆØ±Ø¯Ø© Ù…Ù† ÙƒÙˆØ¯Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
    function tapWar() {
        rRef.child('war').transaction(d => {
            if(!d) d = {p1:50, p2:50};
            myRole==='p1' ? (d.p1+=2, d.p2-=2) : (d.p2+=2, d.p1-=2);
            return d;
        });
    }

    function addBomb(n) {
        rRef.child('bomb').once('value', s => {
            const d = s.val() || {val:0, limit: 35, turn:'p1'};
            if(d.turn !== myRole) return;
            let nv = d.val + n;
            rRef.child('bomb').update({ val:nv, turn:(myRole==='p1'?'p2':'p1'), status: nv>=d.limit?'exploded':'playing' });
        });
    }

    // --- (Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø´Ø§ÙŠØ¨ Ùˆ XO Ù…Ù† ÙƒÙˆØ¯Ùƒ ÙƒÙ…Ø§ Ù‡ÙŠ) ---
    function setupSh() {
        const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        let deck = []; ranks.forEach(r => ['H','S','D','C'].forEach(s => deck.push({r,s})));
        deck.splice(0,1); deck.push({r:'SHAIEB', s:'ğŸ¤¡'}); deck.sort(()=>Math.random()-0.5);
        rRef.child('sh').set({ p1C: deck.slice(0,26), p2C: deck.slice(26), turn:'p1' });
    }

    function renderSh(d) {
        const myC = (myRole==='p1'?d.p1C:d.p2C) || [], opC = (myRole==='p1'?d.p2C:d.p1C) || [];
        const opB = document.getElementById('op-area'); opB.innerHTML = "";
        opC.forEach((_,i) => { let v = document.createElement('div'); v.className="card back"; v.onclick=()=>pullSh(i); opB.appendChild(v); });
        const myB = document.getElementById('my-area'); myB.innerHTML = "";
        myC.forEach(c => { let v = document.createElement('div'); v.className="card"; v.innerText = c.r==='SHAIEB'?'ğŸ¤¡':c.r; myB.appendChild(v); });
    }

    function pullSh(idx) {
        if(myRole==='viewer') return;
        rRef.child('sh').once('value', s => {
            let d = s.val(); if(d.turn !== myRole) return;
            let mk = myRole+'C', ok = (myRole==='p1'?'p2':'p1')+'C';
            let ma = d[mk], oa = d[ok];
            ma.push(oa.splice(idx,1)[0]);
            rRef.child('sh').update({ [mk]:ma, [ok]:oa, turn:(myRole==='p1'?'p2':'p1') });
        });
    }

    function initXO() {
        const b = document.getElementById('xo-board'); b.innerHTML = "";
        for(let i=0; i<9; i++) { let v = document.createElement('div'); v.className="cell"; v.onclick=()=>tapXO(i); b.appendChild(v); }
    }

    function tapXO(i) {
        rRef.child('xo').once('value', s => {
            let d = s.val() || { b: Array(9).fill(""), turn: "p1" };
            if(myRole !== d.turn || d.b[i] || d.win) return;
            d.b[i] = (myRole === 'p1') ? 'X' : 'O';
            const wns = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            wns.forEach(w => { if(d.b[w[0]] && d.b[w[0]]===d.b[w[1]] && d.b[w[0]]===d.b[w[2]]) d.win=d.b[w[0]]; });
            d.turn = (myRole==='p1'?'p2':'p1');
            rRef.child('xo').update(d);
        });
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function showBigMsg(txt) {
        const t = document.createElement('div'); t.className='toast'; t.innerText=txt;
        document.body.appendChild(t); setTimeout(()=>t.remove(), 2500);
    }
</script>
</body>
</html>
